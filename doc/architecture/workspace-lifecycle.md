# User Worker Space - Per-Project –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–î–∞—Ç–∞:** 18 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
3. [Per-Project —Å—Ç—Ä—É–∫—Ç—É—Ä–∞](#per-project-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
4. [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Workspace](#–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª-workspace)
5. [–î–∏–∞–≥—Ä–∞–º–º—ã –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π](#–¥–∏–∞–≥—Ä–∞–º–º—ã-–≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π)
6. [–î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–¥–∏–∞–≥—Ä–∞–º–º—ã-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
7. [–ò–∑–æ–ª—è—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–∏–∑–æ–ª—è—Ü–∏—è-–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
8. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

**User Worker Space** - —ç—Ç–æ per-project –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ backend —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

- **Agent Cache** - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- **Agent Bus** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- **Qdrant Collections** - –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- **Lifecycle Management** - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ cleanup —Ä–µ—Å—É—Ä—Å–æ–≤

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

```
üéØ Per-Project –∏–∑–æ–ª—è—Ü–∏—è
   ‚îî‚îÄ –ö–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π workspace
   ‚îî‚îÄ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è backend —Ä–µ—Å—É—Ä—Å–æ–≤
   ‚îî‚îÄ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã

üîÑ –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ lifecycle
   ‚îî‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
   ‚îî‚îÄ Graceful cleanup –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
   ‚îî‚îÄ Graceful shutdown –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
   ‚îî‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º workspace
   ‚îî‚îÄ Health check –¥–ª—è workspace
   ‚îî‚îÄ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. WorkerSpaceManager (Singleton)

**–†–æ–ª—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –≤—Å–µ—Ö workspace  
**–§–∞–π–ª:** [`app/core/worker_space_manager.py`](../../app/core/worker_space_manager.py)

```python
class WorkerSpaceManager:
    """Singleton manager for all user worker spaces.
    
    Each (user_id, project_id) pair has exactly one UserWorkerSpace.
    """
    
    # –•—Ä–∞–Ω–∏–ª–∏—â–µ workspace
    spaces: dict[str, UserWorkerSpace]  # Key: "{user_id}_{project_id}"
    
    # –û–±—â–∏–π Agent Bus –¥–ª—è –≤—Å–µ—Ö workspace
    agent_bus: AgentBus
    
    # –ú–µ—Ç–æ–¥—ã
    async def get_or_create(user_id, project_id, ...) -> UserWorkerSpace
    async def get(user_id, project_id) -> Optional[UserWorkerSpace]
    async def remove(user_id, project_id) -> bool
    async def cleanup_all() -> None  # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    def get_stats() -> dict  # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –°–æ–∑–¥–∞–Ω–∏–µ workspace –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ workspace –≤ –ø–∞–º—è—Ç–∏
- Thread-safe –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ double-check locking
- Graceful cleanup –≤—Å–µ—Ö workspace

### 2. UserWorkerSpace (Per-Project)

**–†–æ–ª—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞  
**–§–∞–π–ª:** [`app/core/user_worker_space.py`](../../app/core/user_worker_space.py)

```python
class UserWorkerSpace:
    """Worker space for managing user's project resources."""
    
    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
    user_id: UUID
    project_id: str
    user_prefix: str = f"user{user_id}"
    project_prefix: str = f"project{project_id}"
    
    # Backend —Ä–µ—Å—É—Ä—Å—ã
    agent_cache: AgentCache  # Per-project cache
    agent_manager: AgentManager  # Database access
    agent_bus: AgentBus  # Task queue manager
    qdrant: AsyncQdrantClient  # Vector store
    redis: Redis  # Distributed cache
    
    # –°–æ—Å—Ç–æ—è–Ω–∏–µ
    initialized: bool
    active_agents: dict[UUID, ContextualAgent]
    
    # –ú–µ—Ç–æ–¥—ã
    async def initialize() -> None
    async def get_agent(agent_id) -> Optional[ContextualAgent]
    async def add_agent(agent_config) -> UUID
    async def remove_agent(agent_id) -> bool
    async def cleanup() -> None
    async def reset() -> None
```

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è backend —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–¥–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤ –≤ Agent Bus
- Graceful cleanup –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

### 3. get_worker_space Dependency

**–†–æ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ workspace  
**–§–∞–π–ª:** [`app/dependencies.py`](../../app/dependencies.py)

```python
async def get_worker_space(
    project_id: UUID,
    request: Request,
    db: AsyncSession = Depends(get_db),
    redis: Redis = Depends(get_redis),
    qdrant: AsyncQdrantClient = Depends(get_qdrant),
) -> UserWorkerSpace:
    """Get or create UserWorkerSpace for current user and project."""
    
    user_id = get_current_user_id(request)
    manager = get_worker_space_manager()
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ get_or_create
    space = await manager.get_or_create(
        user_id=user_id,
        project_id=str(project_id),
        db=db,
        redis=redis,
        qdrant=qdrant,
    )
    return space
```

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- Injection workspace –≤ endpoints
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è workspace

### 4. Endpoints (Per-Project)

**–ú–∞—Ä—à—Ä—É—Ç—ã:**
- `/my/projects/{project_id}/chat/` - Chat endpoints
- `/my/projects/{project_id}/agents/` - Agent endpoints
- `/my/projects/{project_id}/chat/{session_id}/events/` - Streaming

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
@router.get("/agents/")
async def list_agents(
    project_id: UUID,
    workspace: UserWorkerSpace = Depends(get_worker_space),  # ‚Üê –ê–≤—Ç–æ–∏–Ω—ä–µ–∫—Ü–∏—è
) -> AgentListResponse:
    # workspace —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
    agents = await workspace.agent_manager.list_agents_by_project(project_id)
    return AgentListResponse(agents=agents, total=len(agents))
```

---

## Per-Project —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ú–Ω–æ–≥–æ–ø—Ä–æ–µ–∫—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
User (user_id=abc-123, email=user@example.com)
‚îÇ
‚îú‚îÄ Project A (project_id=proj_001)
‚îÇ  ‚îú‚îÄ UserWorkerSpace(abc-123, proj_001)
‚îÇ  ‚îÇ  ‚îú‚îÄ AgentCache
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ agent1_config: {name, system_prompt, model, ...}
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ agent2_config: {name, system_prompt, model, ...}
‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ AgentBus
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ agent1_queue: asyncio.Queue
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ agent2_queue: asyncio.Queue
‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Qdrant Collections
‚îÇ  ‚îÇ     ‚îî‚îÄ user_abc_project_proj_001_agent1_context
‚îÇ  ‚îÇ     ‚îî‚îÄ user_abc_project_proj_001_agent2_context
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ Database
‚îÇ     ‚îî‚îÄ agents (project_id=proj_001)
‚îÇ     ‚îî‚îÄ chat_sessions (project_id=proj_001)
‚îÇ     ‚îî‚îÄ messages (project_id=proj_001)
‚îÇ
‚îú‚îÄ Project B (project_id=proj_002)  ‚Üê –û–¢–î–ï–õ–¨–ù–´–ô WORKSPACE!
‚îÇ  ‚îú‚îÄ UserWorkerSpace(abc-123, proj_002)
‚îÇ  ‚îÇ  ‚îú‚îÄ AgentCache (—Ç–æ–ª—å–∫–æ –¥–ª—è Project B)
‚îÇ  ‚îÇ  ‚îú‚îÄ AgentBus (–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π)
‚îÇ  ‚îÇ  ‚îî‚îÄ Qdrant Collections (user_abc_project_proj_002_*)
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ Database
‚îÇ     ‚îî‚îÄ agents (project_id=proj_002)
‚îÇ     ‚îî‚îÄ chat_sessions (project_id=proj_002)
‚îÇ
‚îî‚îÄ Project C (project_id=proj_003)
   ‚îî‚îÄ UserWorkerSpace(abc-123, proj_003)
      ‚îú‚îÄ AgentCache
      ‚îú‚îÄ AgentBus
      ‚îî‚îÄ Qdrant Collections
```

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ö–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π workspace** - –Ω–µ –æ–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã
2. **–ò–∑–æ–ª—è—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö:**
   - Cache: —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ `user{id}_project{id}`
   - Agent Bus: —Ä–∞–∑–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
   - Qdrant: —Ä–∞–∑–Ω—ã–µ collections –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
3. **–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã** - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å Project A –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ B, C

---

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Workspace

### 1Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Startup)

```mermaid
sequenceDiagram
    participant App as FastAPI App
    participant Lifespan as Lifespan Manager
    participant Manager as WorkerSpaceManager
    
    App->>Lifespan: startup
    Lifespan->>Manager: get_worker_space_manager()
    Manager-->>Lifespan: singleton instance
    Note over Manager: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ workspaces –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã
    Lifespan-->>App: app ready
```

### 2Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ Workspace (First Request)

```mermaid
sequenceDiagram
    participant Client as HTTP Client
    participant Endpoint as Endpoint
    participant Dependency as get_worker_space
    participant Manager as WorkerSpaceManager
    participant Space as UserWorkerSpace
    participant AgentBus as AgentBus
    participant DB as Database
    
    Client->>Endpoint: GET /my/projects/proj_001/agents/
    Endpoint->>Dependency: inject workspace
    Dependency->>Manager: get_or_create(user_123, proj_001)
    
    Manager-->>Manager: Key in cache?
    alt –ù–µ—Ç –≤ –∫–µ—à–µ
        Manager->>Space: new UserWorkerSpace(user_123, proj_001)
        Space->>Space: initialize()
        
        Space->>DB: load_project_agents()
        DB-->>Space: [agent1, agent2, ...]
        
        loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
            Space->>AgentBus: register_agent(agent.id)
            AgentBus-->>Space: registered
        end
        
        Space-->>Manager: initialized workspace
        Manager-->>Manager: cache[(user_123, proj_001)] = space
    else –ï—Å—Ç—å –≤ –∫–µ—à–µ
        Manager-->>Manager: return cached
    end
    
    Manager-->>Dependency: workspace
    Dependency-->>Endpoint: workspace
    Endpoint->>Endpoint: list_agents using workspace
    Endpoint-->>Client: 200 OK
```

### 3Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Workspace (Subsequent Requests)

```mermaid
sequenceDiagram
    participant Client as HTTP Client
    participant Endpoint as Endpoint
    participant Manager as WorkerSpaceManager
    participant Cache as Workspace Cache
    
    Client->>Endpoint: GET /my/projects/proj_001/chat/sessions/
    Endpoint->>Manager: get_or_create(user_123, proj_001)
    Manager->>Cache: lookup key
    Cache-->>Manager: cached workspace
    Manager-->>Endpoint: workspace
    Endpoint->>Endpoint: use workspace
    Endpoint-->>Client: 200 OK
```

### 4Ô∏è‚É£ Cleanup Workspace (Project Deletion)

```mermaid
sequenceDiagram
    participant Client as HTTP Client
    participant Endpoint as DELETE Endpoint
    participant Manager as WorkerSpaceManager
    participant Space as UserWorkerSpace
    participant AgentBus as AgentBus
    participant Cache as AgentCache
    participant DB as Database
    
    Client->>Endpoint: DELETE /my/projects/proj_001
    Endpoint->>Manager: remove(user_123, proj_001)
    
    Manager->>Space: cleanup()
    Space->>AgentBus: deregister_agent(agent1)
    Space->>AgentBus: deregister_agent(agent2)
    
    Space->>Cache: clear()
    Space-->>Manager: cleanup complete
    Manager-->>Manager: del spaces[(user_123, proj_001)]
    
    Endpoint->>DB: delete project
    DB-->>Endpoint: deleted
    Endpoint-->>Client: 204 No Content
```

### 5Ô∏è‚É£ Shutdown (Application Termination)

```mermaid
sequenceDiagram
    participant OS as Operating System
    participant App as FastAPI App
    participant Lifespan as Lifespan Manager
    participant Manager as WorkerSpaceManager
    
    OS->>App: SIGTERM
    App->>Lifespan: shutdown
    Lifespan->>Manager: cleanup_all()
    
    Note over Manager: Cleanup each workspace
    Manager->>Manager: deregister agents
    Manager->>Manager: clear caches
    Manager->>Manager: close connections
    
    Manager-->>Lifespan: cleanup complete
    Lifespan->>Lifespan: close_db()
    Lifespan->>Lifespan: close_redis()
    Lifespan->>Lifespan: close_qdrant()
    Lifespan-->>App: shutdown complete
    App-->>OS: exit(0)
```

---

## –î–∏–∞–≥—Ä–∞–º–º—ã –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```mermaid
graph TB
    subgraph App["FastAPI Application"]
        Lifespan["Lifespan Manager"]
    end
    
    subgraph Manager["WorkerSpaceManager"]
        WSM["Singleton<br/>spaces: Dict"]
        SharedBus["Shared AgentBus"]
    end
    
    subgraph Workspaces["User Workspaces"]
        WS1["UserWorkerSpace<br/>proj_001"]
        WS2["UserWorkerSpace<br/>proj_002"]
        WS3["UserWorkerSpace<br/>proj_003"]
    end
    
    subgraph Backend["Backend Resources"]
        Qdrant["Qdrant Vector DB"]
        Redis["Redis Cache"]
        DB["PostgreSQL"]
    end
    
    Lifespan -->|manage| WSM
    WSM -->|contains| WS1
    WSM -->|contains| WS2
    WSM -->|contains| WS3
    
    WS1 -->|access| Qdrant
    WS1 -->|access| Redis
    WS1 -->|access| DB
    WS1 -->|use| SharedBus
    
    WS2 -->|access| Qdrant
    WS2 -->|access| Redis
    WS2 -->|access| DB
    WS2 -->|use| SharedBus
    
    style Manager fill:#ffccbc
    style Workspaces fill:#c8e6c9
    style Backend fill:#b3e5fc
```

### Per-Project –ò–∑–æ–ª—è—Ü–∏—è

```mermaid
graph TB
    User["User abc-123"]
    
    subgraph ProjA["Project A"]
        AgentsA["Agents A"]
        CacheA["Cache Keys:<br/>user_abc_proj_001_*"]
        QdrantA["Collections:<br/>user_abc_proj_001_*"]
    end
    
    subgraph ProjB["Project B"]
        AgentsB["Agents B"]
        CacheB["Cache Keys:<br/>user_abc_proj_002_*"]
        QdrantB["Collections:<br/>user_abc_proj_002_*"]
    end
    
    User -->|owns| ProjA
    User -->|owns| ProjB
    
    AgentsA -.->|isolated| AgentsB
    CacheA -.->|no overlap| CacheB
    QdrantA -.->|separate| QdrantB
    
    style ProjA fill:#c8e6c9
    style ProjB fill:#fff9c4
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è Workspace (State Machine)

```mermaid
stateDiagram-v2
    [*] --> NotInitialized
    
    NotInitialized --> Initializing: First request
    
    Initializing --> Initialized: All agents registered
    Initializing --> Error: Init failed
    
    Error --> Initializing: Retry
    
    Initialized --> InUse: Request handled
    InUse --> Initialized: Response sent
    
    Initialized --> Cleaning: Project deleted
    Cleaning --> Cleaned: Cleanup complete
    
    Initialized --> Shutdown: App shutdown
    Shutdown --> Cleaned: Cleanup complete
    
    Cleaned --> [*]
    
    note right of Initializing
        Load agents from DB
        Create cache entries
        Register in Agent Bus
    end note
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–µ–∫—Ç—É

```
1. HTTP GET /my/projects/proj_001/agents/
2. get_worker_space dependency –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. WorkerSpaceManager.get_or_create(user_123, proj_001) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
4. –ü—Ä–æ–≤–µ—Ä–∫–∞: key –≤ cache? –ù–ï–¢
5. –°–æ–∑–¥–∞–Ω–∏–µ: new UserWorkerSpace(user_123, proj_001)
6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: space.initialize()
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤ –∏–∑ –ë–î
   - –°–æ–∑–¥–∞–Ω–∏–µ cache entries
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Agent Bus
7. –í–æ–∑–≤—Ä–∞—Ç: UserWorkerSpace –≤ endpoint
8. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: endpoint –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
9. –û—Ç–≤–µ—Ç: 200 OK —Å —Å–ø–∏—Å–∫–æ–º –∞–≥–µ–Ω—Ç–æ–≤
```

### –ü—Ä–∏–º–µ—Ä 2: –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–æ–º—É –∂–µ –ø—Ä–æ–µ–∫—Ç—É

```
1. HTTP GET /my/projects/proj_001/chat/sessions/
2. get_worker_space dependency –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. WorkerSpaceManager.get_or_create(user_123, proj_001) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
4. –ü—Ä–æ–≤–µ—Ä–∫–∞: key –≤ cache? –î–ê!
5. –í–æ–∑–≤—Ä–∞—Ç: cached UserWorkerSpace (FAST PATH!)
6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: endpoint –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π workspace
7. –û—Ç–≤–µ—Ç: 200 OK —Å —Å–µ—Å—Å–∏—è–º–∏
```

### –ü—Ä–∏–º–µ—Ä 3: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏

```
Timeline:
t=0ms:  GET /my/projects/proj_001/agents/ 
        ‚Üí Creates UserWorkerSpace(user_123, proj_001)

t=100ms: GET /my/projects/proj_002/agents/
         ‚Üí Creates UserWorkerSpace(user_123, proj_002)
         ‚Üí proj_001 workspace –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏

t=200ms: POST /my/projects/proj_001/chat/msg
         ‚Üí Returns cached UserWorkerSpace(user_123, proj_001)

t=300ms: DELETE /my/projects/proj_002
         ‚Üí Calls manager.remove(user_123, proj_002)
         ‚Üí Cleanup workspace –¥–ª—è proj_002
         ‚Üí proj_001 workspace –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check Endpoint

```bash
GET /admin/workspaces/health

Response:
{
    "healthy": true,
    "total_spaces": 3,
    "healthy_spaces": 3,
    "unhealthy_spaces": [],
    "details": {
        "user123_proj001": {
            "healthy": true,
            "agents": 3,
            "initialized": true
        },
        "user123_proj002": {
            "healthy": true,
            "agents": 2,
            "initialized": true
        },
        "user456_proj001": {
            "healthy": true,
            "agents": 5,
            "initialized": true
        }
    }
}
```

### Statistics Endpoint

```bash
GET /admin/workspaces/stats

Response:
{
    "active_spaces": 3,
    "spaces": {
        "user123_proj001": {
            "user_id": "user123",
            "project_id": "proj_001",
            "initialized": true,
            "active_agents": 3,
            "cache_size": 3,
            "agent_ids": ["agent1-id", "agent2-id", "agent3-id"],
            "initialization_time": "2026-02-18T12:00:00"
        }
    }
}
```

---

## –†–µ–∑—é–º–µ

| –ê—Å–ø–µ–∫—Ç | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|
| Per-Project –ò–∑–æ–ª—è—Ü–∏—è | –û—Ç–¥–µ–ª—å–Ω—ã–π UserWorkerSpace –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ |
| –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è | get_worker_space dependency –≤—ã–∑—ã–≤–∞–µ—Ç get_or_create |
| –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ | WorkerSpaceManager –∫–µ—à–∏—Ä—É–µ—Ç workspace –≤ –ø–∞–º—è—Ç–∏ |
| Thread-Safety | Double-check locking –ø–∞—Ç—Ç–µ—Ä–Ω |
| Graceful Shutdown | cleanup_all() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | Endpoints –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ health check |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∞–≥–µ–Ω—Ç–æ–≤ |

–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–µ–∫—Ç–æ–≤.
