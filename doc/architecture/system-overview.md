# –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–∏—Å—Ç–µ–º—ã CodeLab Core Service

## –í–≤–µ–¥–µ–Ω–∏–µ

CodeLab Core Service - —ç—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è AI –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é AI –∫–æ–º–∞–Ω–¥—É —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏, —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

## –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. 100% –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤
- –ù–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- Middleware-based –∏–∑–æ–ª—è—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö `/my/*` endpoints
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ Qdrant –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞

### 2. –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã

#### üß† –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –≥—Ä–∞—Ñ –∑–∞–¥–∞—á
- –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 5-10 —Å–µ–∫—É–Ω–¥
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –∑–∞–¥–∞—á

#### ‚ö° –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ `@agent_name`
- –û–±—Ö–æ–¥–∏—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 1-2 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 3. –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å
- –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –∏–º–µ–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π Qdrant –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1M+ –≤–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è RAG
- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### 4. Real-time –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
- Streaming Fetch API –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (NDJSON —Ñ–æ—Ä–º–∞—Ç)
- –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤ Redis (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–±—ã—Ç–∏–π, TTL 5 –º–∏–Ω—É—Ç)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- Heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph "CLIENT LAYER"
        WebUI[Web UI]
        Mobile[Mobile App]
        API[API Client]
    end
    
    subgraph "API GATEWAY LAYER"
        FastAPI[FastAPI Application]
        Middleware[User Isolation Middleware]
        Routes[Routes: Agents, Chat, Streaming, Health]
    end
    
    subgraph "BUSINESS LOGIC LAYER"
        subgraph "User Worker Space"
            AgentMgr[Agent Manager]
            AgentBus[Agent Bus]
            StreamMgr[Stream Manager]
            CtxAgent[Contextual Agent]
            Orch[Orchestrator]
            Approval[Approval Manager]
        end
    end
    
    subgraph "DATA LAYER"
        Postgres[(PostgreSQL<br/>Users, Agents,<br/>Sessions, Messages)]
        Redis[(Redis<br/>Queues, Cache,<br/>Stream Buffer)]
        Qdrant[(Qdrant<br/>Vectors,<br/>Context, RAG)]
    end
    
    WebUI --> FastAPI
    Mobile --> FastAPI
    API --> FastAPI
    
    FastAPI --> Middleware
    Middleware --> Routes
    
    Routes --> AgentMgr
    Routes --> AgentBus
    Routes --> StreamMgr
    
    AgentMgr --> CtxAgent
    AgentBus --> CtxAgent
    CtxAgent --> Orch
    CtxAgent --> Approval
    
    AgentMgr --> Postgres
    AgentMgr --> Redis
    AgentMgr --> Qdrant
    
    CtxAgent --> Qdrant
    StreamMgr --> Redis
    AgentBus --> Redis
    
    Routes --> Postgres
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### API Gateway Layer

#### FastAPI Application
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–æ–π HTTP —Å–µ—Ä–≤–µ—Ä –∏ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: FastAPI 0.115+, Uvicorn
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Pydantic)
  - OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
  - CORS middleware

#### User Isolation Middleware
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏–∑–æ–ª—è—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ú–µ—Ö–∞–Ω–∏–∑–º**: JWT —Ç–æ–∫–µ–Ω ‚Üí User ID ‚Üí Request State
- **–ó–∞—â–∏—Ç–∞**: –í—Å–µ `/my/*` endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–ò–Ω—ä–µ–∫—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**:
  - `request.state.user_id` - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `request.state.user_prefix` - –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
  - `request.state.db_filter` - —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ë–î –∑–∞–ø—Ä–æ—Å–æ–≤

### Business Logic Layer

#### Agent Manager
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∞–≥–µ–Ω—Ç–æ–≤
- **–û–ø–µ—Ä–∞—Ü–∏–∏**:
  - –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ (CRUD)
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  - –£–¥–∞–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
  - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:
  - PostgreSQL –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
  - Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
  - Qdrant –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

#### Agent Bus
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∑–∞–¥–∞—á –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: asyncio.Queue per agent
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—è–º–∏ –∑–∞–¥–∞—á
  - –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ (max 3 –∑–∞–¥–∞—á–∏)
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –æ—à–∏–±–æ–∫
- **–ú–µ—Ç—Ä–∏–∫–∏**:
  - –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
  - –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### Contextual Agent
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ê–≥–µ–Ω—Ç —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
  - LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (OpenAI/LiteLLM)
  - RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç (Qdrant)
  - –ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (tools)
- **–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**:
  1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  2. –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (RAG)
  3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  4. –í—ã–∑–æ–≤ LLM
  5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

#### Stream Manager
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ real-time —Å–æ–±—ã—Ç–∏—è–º–∏ —á–µ—Ä–µ–∑ Streaming Fetch API
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è streaming —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (NDJSON —Ñ–æ—Ä–º–∞—Ç)
  - Broadcast —Å–æ–±—ã—Ç–∏–π –ø–æ —Å–µ—Å—Å–∏—è–º
  - –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤ Redis
  - Heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  - –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –≤ Redis
  - Heartbeat (30 —Å–µ–∫)
  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- **–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π**:
  - `DIRECT_AGENT_CALL` - –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –∞–≥–µ–Ω—Ç–∞
  - `TASK_STARTED` - –Ω–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏
  - `TASK_COMPLETED` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
  - `CONTEXT_RETRIEVED` - –ø–æ–ª—É—á–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç
  - `ERROR` - –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### Data Layer

#### PostgreSQL
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- **–°—Ö–µ–º–∞**:
  - `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
  - `user_agents` - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã
  - `user_orchestrators` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
  - `chat_sessions` - —á–∞—Ç —Å–µ—Å—Å–∏–∏
  - `messages` - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö
  - `tasks` - –∑–∞–¥–∞—á–∏ –∞–≥–µ–Ω—Ç–æ–≤
  - `approval_requests` - –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- **–ò–Ω–¥–µ–∫—Å—ã**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è user_id —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- **–ú–∏–≥—Ä–∞—Ü–∏–∏**: Alembic –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ö–µ–º—ã

#### Redis
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö—ç—à –∏ –æ—á–µ—Ä–µ–¥–∏
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
  - –ö—ç—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∞–≥–µ–Ω—Ç–æ–≤ (TTL 5 –º–∏–Ω)
  - –ë—É—Ñ–µ—Ä streaming —Å–æ–±—ã—Ç–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100, TTL 5 –º–∏–Ω)
  - Agent Bus –æ—á–µ—Ä–µ–¥–∏
  - Rate limiting
  - Distributed locks
- **–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**:
  - Strings –¥–ª—è –∫—ç—à–∞
  - Lists –¥–ª—è –±—É—Ñ–µ—Ä–æ–≤ —Å–æ–±—ã—Ç–∏–π
  - Pub/Sub –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### Qdrant
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏
- **–ö–æ–ª–ª–µ–∫—Ü–∏–∏**: `user{id}_{agent_name}_context`
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
  - –†–∞–∑–º–µ—Ä –≤–µ–∫—Ç–æ—Ä–∞: 1536 (OpenAI embeddings)
  - –ú–µ—Ç—Ä–∏–∫–∞: Cosine similarity
  - –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è: HNSW
- **–î–∞–Ω–Ω—ã–µ**:
  - –í–µ–∫—Ç–æ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
  - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
  - –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
- **–û–ø–µ—Ä–∞—Ü–∏–∏**:
  - Hybrid search (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π + —Ñ–∏–ª—å—Ç—Ä—ã)
  - Upsert –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
  - Pruning —Å—Ç–∞—Ä—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–æ–∫ 1: –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –∞–≥–µ–Ω—Ç–∞

```mermaid
sequenceDiagram
    participant User
    participant FastAPI
    participant Middleware
    participant ChatRoute
    participant AgentMgr
    participant CtxAgent
    participant StreamMgr
    participant Qdrant
    participant LLM
    participant Postgres
    
    User->>FastAPI: POST /my/chat/{session_id}/message/<br/>{target_agent: "coder"}
    FastAPI->>Middleware: Authenticate
    Middleware->>Middleware: Extract user_id from JWT
    Middleware->>ChatRoute: Forward with user_id
    
    ChatRoute->>Postgres: Save user message
    ChatRoute->>AgentMgr: Get agent by name
    AgentMgr-->>ChatRoute: Agent config
    
    ChatRoute->>StreamMgr: Broadcast DIRECT_AGENT_CALL event
    ChatRoute->>CtxAgent: Create contextual agent
    
    CtxAgent->>Qdrant: Search relevant context (RAG)
    Qdrant-->>CtxAgent: Top-K context vectors
    
    ChatRoute->>StreamMgr: Broadcast CONTEXT_RETRIEVED event
    
    CtxAgent->>LLM: Call with context + history
    LLM-->>CtxAgent: Response
    
    CtxAgent->>Qdrant: Save interaction
    ChatRoute->>Postgres: Save assistant message
    
    ChatRoute->>StreamMgr: Broadcast TASK_COMPLETED event
    ChatRoute-->>User: Return assistant message
```

### –ü–æ—Ç–æ–∫ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞

```mermaid
sequenceDiagram
    participant User
    participant FastAPI
    participant Middleware
    participant AgentsRoute
    participant AgentMgr
    participant Postgres
    participant Redis
    participant Qdrant
    
    User->>FastAPI: POST /my/agents/<br/>{name, config}
    FastAPI->>Middleware: Authenticate
    Middleware->>AgentsRoute: Forward with user_id
    
    AgentsRoute->>AgentMgr: Create agent
    AgentMgr->>Postgres: Insert user_agent record
    AgentMgr->>Qdrant: Initialize collection<br/>user{id}_{name}_context
    AgentMgr->>Redis: Cache config (TTL 5min)
    
    AgentMgr-->>AgentsRoute: Agent response
    AgentsRoute-->>User: Return agent details
```

### –ü–æ—Ç–æ–∫ 3: Streaming –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```mermaid
sequenceDiagram
    participant User
    participant FastAPI
    participant Middleware
    participant StreamRoute
    participant StreamMgr
    participant Redis
    
    User->>FastAPI: GET /my/sse/{session_id}
    FastAPI->>Middleware: Authenticate
    Middleware->>StreamRoute: Forward with user_id

    StreamRoute->>StreamMgr: Register connection
    StreamMgr->>StreamMgr: Create asyncio.Queue
    StreamMgr->>Redis: Get buffered events
    Redis-->>StreamMgr: Buffered events

    StreamMgr->>User: Send buffered events (NDJSON)

    loop Heartbeat every 30s
        StreamMgr->>User: Send heartbeat (JSON event)
    end

    loop On events
        StreamMgr->>User: Stream events (NDJSON)
    end

    User->>FastAPI: Disconnect
    StreamRoute->>StreamMgr: Unregister connection
```

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```mermaid
erDiagram
    users ||--o{ user_agents : owns
    users ||--o{ user_orchestrators : has
    users ||--o{ chat_sessions : creates
    users ||--o{ approval_requests : requests
    
    chat_sessions ||--o{ messages : contains
    chat_sessions ||--o{ tasks : has
    
    user_agents ||--o{ messages : generates
    user_agents ||--o{ tasks : executes
    
    users {
        uuid id PK
        string email UK
        timestamp created_at
    }
    
    user_agents {
        uuid id PK
        uuid user_id FK
        string name
        jsonb config
        string status
        timestamp created_at
    }
    
    user_orchestrators {
        uuid id PK
        uuid user_id FK,UK
        jsonb config
        timestamp created_at
    }
    
    chat_sessions {
        uuid id PK
        uuid user_id FK
        timestamp created_at
    }
    
    messages {
        uuid id PK
        uuid session_id FK
        string role
        text content
        uuid agent_id FK
        timestamp created_at
    }
    
    tasks {
        uuid id PK
        uuid session_id FK
        uuid agent_id FK
        string status
        jsonb result
        timestamp created_at
        timestamp started_at
        timestamp completed_at
    }
    
    approval_requests {
        uuid id PK
        uuid user_id FK
        string type
        jsonb payload
        string status
        timestamp created_at
        timestamp resolved_at
        text decision
    }
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Agent Bus

```mermaid
graph LR
    subgraph "Agent Bus"
        Queue1[Queue: Agent 1<br/>Max: 100 tasks]
        Queue2[Queue: Agent 2<br/>Max: 100 tasks]
        Queue3[Queue: Agent 3<br/>Max: 100 tasks]
        
        Worker1[Worker 1<br/>Concurrency: 3]
        Worker2[Worker 2<br/>Concurrency: 3]
        Worker3[Worker 3<br/>Concurrency: 3]
        
        Queue1 --> Worker1
        Queue2 --> Worker2
        Queue3 --> Worker3
    end
    
    subgraph "Task Execution"
        Worker1 --> Task1[Task 1]
        Worker1 --> Task2[Task 2]
        Worker1 --> Task3[Task 3]
    end
    
    subgraph "Results"
        Task1 --> Result1[Success/Error]
        Task2 --> Result2[Success/Error]
        Task3 --> Result3[Success/Error]
    end
    
    Result1 --> Callback1[Callback]
    Result2 --> Callback2[Callback]
    Result3 --> Callback3[Callback]
```

## –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Stateless API**: –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ë–î/Redis/Qdrant
- **Load Balancer**: Nginx/HAProxy –ø–µ—Ä–µ–¥ FastAPI
- **Database Sharding**: –ü–æ user_id –¥–ª—è PostgreSQL
- **Redis Cluster**: –î–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- **Qdrant Cluster**: –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –≤–µ–∫—Ç–æ—Ä–æ–≤

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **Connection Pooling**: PostgreSQL (10-30 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
- **Redis Pipeline**: –ë–∞—Ç—á–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π
- **Qdrant HNSW**: –ë—ã—Å—Ç—Ä—ã–π approximate search
- **Async I/O**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis –¥–ª—è –≥–æ—Ä—è—á–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Direct call latency**: P95 < 2 —Å–µ–∫
- **Qdrant search**: < 50ms
- **Streaming connections**: 1000+ per user
- **Agent concurrency**: 3 –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **Database queries**: < 100ms P95

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **JWT —Ç–æ–∫–µ–Ω—ã**: HS256 –∞–ª–≥–æ—Ä–∏—Ç–º
- **User isolation**: Middleware –Ω–∞ –≤—Å–µ—Ö endpoints
- **Token expiration**: 30 –º–∏–Ω—É—Ç (access), 7 –¥–Ω–µ–π (refresh)
- **Secret rotation**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–º–µ–Ω—ã –∫–ª—é—á–µ–π

### –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **Database level**: WHERE user_id = :user_id –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- **Qdrant level**: –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ per user/agent
- **Redis level**: –ü—Ä–µ—Ñ–∏–∫—Å—ã –∫–ª—é—á–µ–π —Å user_id
- **API level**: Middleware –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫
- **Rate limiting**: Redis-based (100 req/min)
- **Input validation**: Pydantic schemas
- **SQL injection**: SQLAlchemy ORM
- **XSS protection**: Content-Type headers
- **CORS**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ origins

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

```mermaid
graph TB
    subgraph "Application"
        App[FastAPI App]
    end
    
    subgraph "Metrics Collection"
        Prometheus[Prometheus]
    end
    
    subgraph "Visualization"
        Grafana[Grafana Dashboards]
    end
    
    subgraph "Logging"
        Structlog[Structlog]
        LogAggregator[Log Aggregator<br/>ELK/Loki]
    end
    
    App -->|Metrics| Prometheus
    App -->|Logs| Structlog
    Structlog --> LogAggregator
    Prometheus --> Grafana
    
    Grafana -->|Alerts| AlertManager[Alert Manager]
    AlertManager -->|Notify| Slack[Slack/Email/PagerDuty]
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏**: structlog
- **–£—Ä–æ–≤–Ω–∏**: DEBUG, INFO, WARNING, ERROR
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: user_id, session_id, agent_id
- **–§–æ—Ä–º–∞—Ç**: JSON –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞

### –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus)
- HTTP –∑–∞–ø—Ä–æ—Å—ã (latency, throughput, errors)
- Database connections –∏ query time
- Redis operations
- Agent tasks (queued, running, completed, failed)
- Streaming connections (active, total)
- Qdrant operations (search time, vector count)

### –ê–ª–µ—Ä—Ç—ã
- High error rate (> 5%)
- Slow queries (> 1s)
- Queue overflow
- Memory/CPU usage
- Database connection exhaustion

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker Compose (Development)
```yaml
services:
  - app (FastAPI)
  - postgres (PostgreSQL 16)
  - redis (Redis 7)
  - qdrant (Qdrant latest)
```

### Production (Kubernetes)

```mermaid
graph TB
    subgraph "Kubernetes Cluster"
        subgraph "Ingress"
            Ingress[Ingress Controller<br/>HTTPS, Rate Limiting]
        end
        
        subgraph "Application"
            API1[API Pod 1]
            API2[API Pod 2]
            API3[API Pod 3]
        end
        
        subgraph "Databases"
            PG[PostgreSQL<br/>StatefulSet]
            Redis[Redis<br/>StatefulSet]
            Qdrant[Qdrant<br/>StatefulSet]
        end
        
        subgraph "Storage"
            PV1[PersistentVolume<br/>PostgreSQL]
            PV2[PersistentVolume<br/>Redis]
            PV3[PersistentVolume<br/>Qdrant]
        end
    end
    
    Internet[Internet] --> Ingress
    Ingress --> API1
    Ingress --> API2
    Ingress --> API3
    
    API1 --> PG
    API2 --> PG
    API3 --> PG
    
    API1 --> Redis
    API2 --> Redis
    API3 --> Redis
    
    API1 --> Qdrant
    API2 --> Qdrant
    API3 --> Qdrant
    
    PG --> PV1
    Redis --> PV2
    Qdrant --> PV3
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
1. **Orchestrator** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á
2. **Approval Manager** - –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–∞—Å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. **Tool System** - —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
4. **Multi-modal support** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ
5. **Agent collaboration** - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
6. **Advanced RAG** - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫, re-ranking
7. **Cost tracking** - —É—á–µ—Ç –∑–∞—Ç—Ä–∞—Ç –Ω–∞ LLM –≤—ã–∑–æ–≤—ã
8. **A/B testing** - —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
1. **GraphQL API** - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ REST
2. **WebSocket** - –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è
3. **Event Sourcing** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **CQRS** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏
5. **Distributed tracing** - OpenTelemetry
6. **Service mesh** - Istio –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

CodeLab Core Service –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã—Ö AI —Å–∏—Å—Ç–µ–º. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚úÖ **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–ì–∏–±–∫–∏–µ —Ä–µ–∂–∏–º—ã** —Ä–∞–±–æ—Ç—ã (–ø—Ä—è–º–æ–π/–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
- ‚úÖ **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å** —á–µ—Ä–µ–∑ RAG
- ‚úÖ **Real-time** –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ –∏ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
