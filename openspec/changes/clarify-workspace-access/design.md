# Design: Уточнение механизма доступа к workspace

## Context

При реализации изменения `implement-core-service` возникла необходимость в явном уточнении архитектуры доступа к workspace. Текущая документация содержит неявные предположения о том, как агенты получают доступ к рабочему пространству пользователя, что может привести к неправильной реализации и нарушению изоляции данных.

**Текущее состояние:**
- Спецификация User Worker Space описывает функциональность, но не детализирует архитектурный поток доступа
- Отсутствует явная документация о том, что workspace предоставляется пользователем через client приложение
- Не зафиксировано, что агенты получают доступ к workspace исключительно через tools, а не напрямую
- Нет четкого разделения ответственности между компонентами системы

**Ограничения:**
- Изменение должно быть чисто документационным - не меняет существующую функциональность
- Должно сохранить совместимость с текущей архитектурой
- Не должно требовать изменений в коде (только уточнение документации)

**Заинтересованные стороны:**
- Разработчики backend (понимание архитектуры изоляции)
- Разработчики client приложений (понимание инициализации workspace)
- Разработчики агентов (понимание механизма доступа через tools)
- Архитекторы системы (валидация безопасности и изоляции)

## Goals / Non-Goals

**Goals:**
- Явно документировать, что workspace предоставляется конечным пользователем через client приложение
- Зафиксировать, что агенты получают доступ к workspace только через tools с передачей контекста
- Описать архитектурный поток: User → Client → Backend → Tools → Resources
- Определить границы ответственности каждого компонента в управлении workspace
- Добавить диаграммы и примеры для наглядности архитектурного потока
- Документировать граничные условия безопасности (что агент НЕ может делать)

**Non-Goals:**
- Изменение существующей функциональности или кода
- Реализация новых API endpoints или компонентов
- Изменение механизма аутентификации или авторизации
- Добавление новых инструментов или capabilities для агентов
- Изменение структуры базы данных или схемы Qdrant collections

## Decisions

### Decision 1: Workspace как user-provided ресурс

**Решение:** Явно документировать, что workspace инициализируется и управляется пользователем через client приложение, а не является системным ресурсом.

**Обоснование:**
- Соответствует принципу user ownership - пользователь владеет своими данными и workspace
- Упрощает понимание lifecycle: создание, конфигурация, очистка контролируются пользователем
- Четко разделяет ответственность: client управляет UI/UX workspace, backend обеспечивает backend logic

**Альтернативы:**
- *Системная инициализация workspace*: backend автоматически создает workspace при первом запросе
  - Отклонено: снижает контроль пользователя, усложняет кастомизацию workspace
- *Гибридный подход*: часть workspace управляется системой, часть пользователем
  - Отклонено: создает путаницу в ответственности, усложняет документацию

### Decision 2: Доступ агентов только через tools

**Решение:** Зафиксировать, что агенты НЕ имеют прямого доступа к workspace объекту и получают доступ исключительно через tools с передачей workspace context.

**Обоснование:**
- Обеспечивает изоляцию: агент не может обойти контроль доступа
- Упрощает аудит: все операции с workspace проходят через tools, которые можно логировать
- Гибкость: tools могут применять дополнительные проверки безопасности перед доступом к ресурсам
- Соответствует принципу least privilege: агент получает только те данные, которые запросил через tool

**Альтернативы:**
- *Прямой доступ агентов к workspace*: агент получает workspace объект и работает с ним напрямую
  - Отклонено: нарушает изоляцию, агент может получить доступ к данным других пользователей
- *Смешанный доступ*: некоторые операции через tools, некоторые напрямую
  - Отклонено: создает inconsistency, усложняет безопасность

### Decision 3: Backend координирует workspace lifecycle

**Решение:** User Worker Space компонента backend отвечает за инициализацию, управление и cleanup workspace на стороне сервера.

**Обоснование:**
- Централизация логики: вся backend логика workspace в одном компоненте
- Интеграция с middleware: User Worker Space использует user_id из JWT для изоляции
- Управление ресурсами: backend контролирует agent_cache, Qdrant collections, Redis keys
- Graceful cleanup: backend может корректно завершить задачи и освободить ресурсы

**Альтернативы:**
- *Распределенное управление*: каждый компонент (Agent Bus, Qdrant, Redis) управляет своей частью workspace
  - Отклонено: усложняет координацию, риск утечки ресурсов при cleanup
- *Client-side управление lifecycle*: client приложение управляет всем lifecycle
  - Отклонено: client не имеет доступа к backend ресурсам (Qdrant, Redis)

### Decision 4: Документирование через обновление существующей спецификации

**Решение:** Добавить новый раздел "Workspace Access Architecture" в существующую спецификацию User Worker Space вместо создания отдельного документа.

**Обоснование:**
- Консолидация: вся информация о User Worker Space в одном месте
- Контекст: разработчики видят архитектуру доступа рядом с requirements
- Избежание дублирования: не нужно повторять базовую информацию о User Worker Space

**Альтернативы:**
- *Отдельный архитектурный документ*: создать `workspace-access-architecture.md`
  - Отклонено: фрагментирует документацию, требует cross-references
- *Обновление общей архитектурной документации*: добавить в `doc/architecture.md`
  - Отклонено: слишком общий уровень, теряется связь с User Worker Space спецификацией

## Risks / Trade-offs

### Risk 1: Документация может устареть при изменении реализации
**Митигация:** 
- Включить проверку документации в процесс code review
- Добавить ссылки на документацию в комментариях к коду User Worker Space
- Периодический аудит соответствия документации и реализации

### Risk 2: Разработчики могут не прочитать уточненную документацию
**Митигация:**
- Добавить диаграммы и визуальные примеры для быстрого понимания
- Включить ключевые моменты в onboarding документацию для новых разработчиков
- Создать checklist для code review с проверкой соответствия архитектуре доступа

### Risk 3: Уточнение может выявить несоответствия в текущей реализации
**Митигация:**
- Провести аудит текущей реализации User Worker Space на соответствие уточненной архитектуре
- Если найдены несоответствия, создать отдельные issues для их исправления
- Документировать временные отклонения с планом их устранения

### Trade-off 1: Детализация vs. Читаемость
**Решение:** Использовать многоуровневую структуру документации:
- Краткий overview с диаграммой для быстрого понимания
- Детальные секции для каждого аспекта (инициализация, tool access, lifecycle)
- Примеры кода для конкретных use cases

### Trade-off 2: Документация vs. Код как источник истины
**Решение:** Документация описывает архитектурные принципы и контракты, код реализует детали. При конфликте - код имеет приоритет, но требует обновления документации.

## Migration Plan

Это документационное изменение, не требующее миграции кода или данных.

**Шаги развертывания:**
1. Создать delta spec с уточнениями для User Worker Space
2. Review delta spec с командой разработки
3. Merge delta spec в main спецификацию User Worker Space
4. Обновить связанную документацию (REST API docs, если требуется)
5. Анонсировать изменения команде через changelog или team meeting

**Rollback стратегия:**
- Документационные изменения можно откатить через git revert
- Нет влияния на работающую систему, rollback не требует downtime

**Валидация:**
- Code review существующей реализации User Worker Space на соответствие уточненной архитектуре
- Проверка, что все tools корректно принимают workspace context параметры
- Валидация, что middleware корректно изолирует workspace между пользователями

## Open Questions

### Q1: Нужно ли добавлять примеры tool signatures с workspace context?
**Статус:** Требует обсуждения с командой разработки агентов

**Варианты:**
- Добавить примеры в спецификацию User Worker Space
- Создать отдельный документ с примерами tool definitions
- Добавить примеры в документацию каждого конкретного tool

**Рекомендация:** Добавить 2-3 примера в спецификацию User Worker Space для иллюстрации паттерна, детальные примеры оставить в документации конкретных tools.

### Q2: Требуется ли обновление REST API документации?
**Статус:** Зависит от того, насколько явно API endpoints документируют workspace context

**Действие:** Проверить `doc/rest-api.md` и определить, нужны ли уточнения о том, какие endpoints инициализируют/управляют workspace.

### Q3: Нужна ли диаграмма sequence для потока workspace access?
**Статус:** Желательно для наглядности

**Рекомендация:** Добавить mermaid sequence diagram в спецификацию, показывающую поток: User → Client → REST API → User Worker Space → Tool → Resource (Qdrant/Redis/DB).
