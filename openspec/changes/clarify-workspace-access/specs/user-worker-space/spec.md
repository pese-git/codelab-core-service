# Спецификация: User Worker Space (Delta)

## MODIFIED Requirements

### Requirement: Инициализация backend ресурсов для работы с workspace
Система ДОЛЖНА создавать backend ресурсы (User Worker Space) для каждого проекта пользователя при первом запросе. Если User Worker Space для проекта уже создавался, система использует созданный ранее. Workspace (файловая система пользователя с локальными файлами, проектами, директориями) уже существует на стороне пользователя. User Worker Space backend компонента управляет backend ресурсами (agent_cache, Agent Bus регистрация) для обслуживания агентов, которые работают с workspace пользователя через tools.

#### Scenario: Первый запрос для проекта пользователя
- **WHEN** пользователь делает первый запрос для конкретного проекта после аутентификации
- **THEN** система создает User Worker Space backend ресурсы для этого проекта с уникальным user_prefix и инициализирует agent_cache для работы с уже существующим workspace пользователя

#### Scenario: Повторный запрос для проекта пользователя
- **WHEN** пользователь делает запрос для проекта и Worker Space backend ресурсы для этого проекта уже существуют
- **THEN** система использует существующие backend ресурсы без повторной инициализации

#### Scenario: Параллельные запросы для одного проекта
- **WHEN** пользователь делает несколько параллельных запросов для одного проекта
- **THEN** все запросы используют одни и те же backend ресурсы Worker Space для этого проекта без конфликтов

#### Scenario: Workspace существует на стороне пользователя
- **WHEN** пользователь работает с системой через client приложение
- **THEN** workspace (файловая система пользователя с локальными файлами, проектами, директориями) уже существует на стороне пользователя, агенты получают доступ к нему исключительно через tools

### Requirement: Интеграция с Qdrant контекстом
Worker Space ДОЛЖЕН обеспечивать доступ к персональному Qdrant контексту агентов. Агенты получают доступ к Qdrant исключительно через tools, которые вызываются с контекстом workspace (файловой системы пользователя).

#### Scenario: Инициализация Qdrant collections для проекта
- **WHEN** Worker Space backend ресурсы инициализируются для проекта
- **THEN** система проверяет существование Qdrant collections для агентов пользователя в контексте этого проекта

#### Scenario: Доступ к контексту агента в рамках проекта
- **WHEN** агент запрашивает RAG контекст в рамках проекта (workspace)
- **THEN** Worker Space предоставляет доступ к соответствующей Qdrant collection (user{id}_{agent_name}_context) в контексте этого проекта

#### Scenario: Создание новой collection для проекта
- **WHEN** создается новый агент в рамках проекта
- **THEN** Worker Space инициирует создание новой Qdrant collection для агента в контексте этого проекта

#### Scenario: Tool вызов с workspace context
- **WHEN** агент вызывает tool для доступа к файлам workspace (например, `tool_read_file`, `tool_list_directory`)
- **THEN** tool получает путь к файлу/директории в workspace пользователя, выполняет операцию и возвращает результат агенту

### Requirement: Изоляция между пользователями
Worker Space ДОЛЖЕН обеспечивать полную изоляцию между пользователями на уровне backend ресурсов. Изоляция обеспечивается на backend уровне через middleware и workspace context в tools, предотвращая доступ к файловой системе других пользователей.

#### Scenario: Независимые Worker Spaces для разных пользователей
- **WHEN** User123 и User456 одновременно используют систему
- **THEN** их Worker Space backend ресурсы полностью изолированы и не имеют общих ресурсов

#### Scenario: Независимые Worker Spaces для разных проектов одного пользователя
- **WHEN** User123 работает с несколькими проектами одновременно
- **THEN** каждый проект имеет свой изолированный Worker Space с отдельными backend ресурсами

#### Scenario: Предотвращение утечки данных
- **WHEN** Worker Space обрабатывает данные пользователя
- **THEN** данные никогда не попадают в Worker Space другого пользователя или другого проекта

#### Scenario: Изоляция на уровне tools
- **WHEN** агент вызывает tool для доступа к файлам workspace
- **THEN** tool выполняет операции только в контексте файловой системы этого пользователя и проекта, не может получить доступ к файлам других пользователей или проектов

### Requirement: Lifecycle management
Worker Space ДОЛЖЕН управлять жизненным циклом backend ресурсов с операциями initialization, cleanup и reset. Workspace (файловая система пользователя) НЕ управляется backend и существует независимо от lifecycle backend ресурсов.

#### Scenario: Graceful cleanup backend ресурсов проекта
- **WHEN** пользователь завершает работу с проектом или истекает timeout неактивности
- **THEN** Worker Space выполняет cleanup backend ресурсов для этого проекта: завершает активные задачи, очищает cache, дерегистрирует агентов, но НЕ удаляет файлы из workspace пользователя

#### Scenario: Force reset backend ресурсов проекта
- **WHEN** администратор или система инициирует reset Worker Space для проекта
- **THEN** Worker Space немедленно останавливает все задачи проекта, очищает все backend ресурсы и реинициализируется, но НЕ затрагивает workspace пользователя

#### Scenario: Crash recovery
- **WHEN** Worker Space падает во время выполнения задач
- **THEN** система автоматически восстанавливает Worker Space backend ресурсы и помечает незавершенные задачи как failed, workspace пользователя остается неизменным

## ADDED Requirements

### Requirement: Архитектура доступа к workspace
Система ДОЛЖНА обеспечивать четкое разделение ответственности в доступе к workspace: workspace (файловая система пользователя) уже существует на стороне пользователя, пользователь предоставляет доступ к workspace через tools, агенты НЕ имеют прямого доступа к файловой системе.

#### Scenario: Workspace существует на стороне пользователя
- **WHEN** пользователь работает с client приложением
- **THEN** workspace (файловая система пользователя с локальными файлами, проектами, директориями) уже существует и управляется пользователем

#### Scenario: Агент запрашивает доступ к файлам workspace
- **WHEN** агент выполняет задачу и требуется доступ к файлам workspace
- **THEN** агент вызывает соответствующий tool (например, `tool_read_file`, `tool_write_file`, `tool_list_directory`) с путем к файлу/директории, tool выполняет операцию в файловой системе пользователя и возвращает результат

#### Scenario: Прямой доступ агента к файловой системе запрещен
- **WHEN** агент пытается получить прямой доступ к файловой системе пользователя
- **THEN** система предотвращает такой доступ, агент может работать с файлами только через tools

#### Scenario: Backend управляет backend ресурсами для проекта
- **WHEN** поступает запрос от пользователя для конкретного проекта
- **THEN** User Worker Space backend компонента создает/использует backend ресурсы (agent_cache, Agent Bus регистрация, Qdrant collections) для обслуживания агентов этого проекта, которые работают с уже существующим workspace пользователя через tools

### Requirement: Tool signatures с workspace context
Все tools, работающие с файловой системой workspace, ДОЛЖНЫ явно принимать пути к файлам/директориям как параметры и выполнять операции в контексте workspace пользователя.

#### Scenario: Tool получает путь к файлу workspace
- **WHEN** tool вызывается агентом для работы с файлом
- **THEN** tool получает путь к файлу (например, `/path/to/project/file.py`) как параметр и выполняет операцию в файловой системе пользователя

#### Scenario: Tool валидирует доступ к workspace
- **WHEN** tool получает путь к файлу/директории
- **THEN** tool проверяет, что путь находится в пределах workspace пользователя и user_id из JWT токена соответствует владельцу workspace

#### Scenario: Tool выполняет операции в workspace пользователя
- **WHEN** tool выполняет операцию с файлом (чтение, запись, удаление)
- **THEN** tool выполняет операцию в файловой системе пользователя и возвращает результат агенту без утечки информации о структуре workspace других пользователей

### Requirement: Backend координация backend ресурсов
User Worker Space компонента backend ДОЛЖНА управлять backend ресурсами (agent_cache, Agent Bus, Qdrant collections) для обслуживания агентов, которые работают с workspace пользователя через tools.

#### Scenario: Backend создает backend ресурсы для проекта
- **WHEN** поступает первый запрос от пользователя для конкретного проекта
- **THEN** User Worker Space создает backend ресурсы для этого проекта: agent_cache для кеширования агентов, регистрирует агентов в Agent Bus, обеспечивает доступ к Qdrant collections

#### Scenario: Backend управляет lifecycle backend ресурсов проекта
- **WHEN** пользователь активно работает с проектом
- **THEN** User Worker Space управляет agent_cache TTL, координирует задачи через Agent Bus, обеспечивает доступ к Qdrant/Redis для этого проекта, но НЕ управляет файловой системой пользователя

#### Scenario: Backend выполняет cleanup backend ресурсов проекта
- **WHEN** пользователь завершает работу с проектом или истекает timeout неактивности
- **THEN** User Worker Space завершает активные задачи проекта, очищает cache, дерегистрирует агентов, освобождает backend ресурсы, но НЕ удаляет файлы из workspace пользователя

### Requirement: Граничные условия безопасности
Система ДОЛЖНА явно определять и обеспечивать граничные условия безопасности для доступа к workspace (файловой системе пользователя).

#### Scenario: Агент не может обойти tools
- **WHEN** агент пытается получить прямой доступ к файловой системе пользователя
- **THEN** система блокирует такой доступ, агент может работать с файлами только через предоставленные tools

#### Scenario: Агент не может управлять workspace напрямую
- **WHEN** агент пытается создать, переместить или удалить директории workspace без использования tools
- **THEN** система отклоняет операцию, агент может выполнять файловые операции только через tools

#### Scenario: Tool не может получить доступ к чужому workspace
- **WHEN** tool вызывается с путем к файлу
- **THEN** tool проверяет, что путь находится в пределах workspace текущего пользователя (user_id из JWT) и не может обратиться к файлам других пользователей

#### Scenario: Middleware обеспечивает изоляцию
- **WHEN** запрос поступает на backend endpoint
- **THEN** user isolation middleware извлекает user_id из JWT и обеспечивает, что все последующие операции с backend ресурсами и tools выполняются в контексте этого пользователя

### Requirement: Документирование архитектурного потока
Спецификация ДОЛЖНА содержать явное описание архитектурного потока доступа к workspace (файловой системе пользователя).

#### Scenario: Поток User Workspace (файловая система) → Agent → Tools → Backend
- **WHEN** разработчик изучает архитектуру системы
- **THEN** документация явно описывает поток: workspace (файловая система пользователя) уже существует на стороне пользователя, агенты вызывают tools для работы с файлами, tools обращаются к backend для валидации и выполнения операций, backend управляет backend ресурсами (agent_cache, Agent Bus, Qdrant) для проекта

#### Scenario: Диаграмма workspace access
- **WHEN** разработчик нуждается в визуальном представлении архитектуры
- **THEN** документация содержит sequence diagram, показывающую: User workspace (файловая система) → Agent вызывает tool → Tool с путем к файлу → Backend валидация → Операция с файлом → Результат агенту

#### Scenario: Примеры tool вызовов для работы с файлами
- **WHEN** разработчик реализует новый tool для работы с workspace
- **THEN** документация предоставляет примеры tool signatures (например, `tool_read_file(path: str, user_id: int)`, `tool_write_file(path: str, content: str, user_id: int)`) и примеры использования

### Requirement: Разделение ответственности компонентов
Система ДОЛЖНА явно разделять ответственность между компонентами в управлении workspace и backend ресурсами.

#### Scenario: Пользователь управляет workspace (файловой системой)
- **WHEN** пользователь работает с client приложением
- **THEN** пользователь управляет своей файловой системой (создает проекты, редактирует файлы, организует директории), workspace существует независимо от backend системы

#### Scenario: Backend управляет backend ресурсами для проекта
- **WHEN** backend получает запрос от пользователя для конкретного проекта
- **THEN** backend создает и управляет backend ресурсами (agent_cache, Agent Bus, Qdrant collections) для обслуживания агентов этого проекта, но НЕ управляет файловой системой пользователя напрямую

#### Scenario: Агенты используют workspace через tools
- **WHEN** агент выполняет задачу, требующую работы с файлами
- **THEN** агент вызывает tools с путями к файлам, tools выполняют операции в файловой системе пользователя от имени агента, агент получает результаты, но НЕ имеет прямого доступа к файловой системе

#### Scenario: Tools как посредники доступа к workspace
- **WHEN** tool вызывается агентом
- **THEN** tool выступает посредником между агентом и файловой системой пользователя: получает путь к файлу, валидирует доступ через backend (user_id из JWT), выполняет операцию, возвращает результат агенту
