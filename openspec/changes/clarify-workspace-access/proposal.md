# OpenSpec Change: clarify-workspace-access
## Уточнение механизма доступа к workspace в личной AI платформе
**Версия:** 1.0  
**Дата:** 11 февраля 2026  

---

## Why

При реализации "implement-core-service" возникла потребность в **четком уточнении механизма доступа к workspace**. Текущая документация и дизайн могут создавать путаницу относительно того, как именно агенты получают доступ к рабочему пространству пользователя.

Ключевые проблемы, которые нужно уточнить:

1. **Отсутствие явного разделения ответственности** - не всегда ясно, что workspace предоставляется **конечным пользователем через client приложение**, а не инициализируется системой для агентов
2. **Путаница в архитектурном потоке доступа** - агенты НЕ имеют прямого доступа к workspace; они получают доступ **исключительно через tools**, которые вызывают с контекстом рабочего пространства
3. **Недостаточная документированность граничных условий** - необходимо явно зафиксировать, что workspace - это экземпляр, управляемый пользователем, а не системный ресурс

Это уточнение критично для:
- Правильного понимания архитектуры изоляции данных
- Разработки user-worker-space компоненты
- Определения API контрактов между client и backend
- Понимания безопасности и контроля доступа

---

## What Changes

### Архитектурное уточнение доступа к workspace

**Исходное предположение** (требует уточнения):
- Агент получает workspace напрямую → работает с ним
- User Worker Space инициализируется системой → предоставляется агентам

**Уточненная модель** (правильная):

1. **Конечный пользователь предоставляет workspace**
   - Client приложение (web, desktop, mobile) имеет экземпляр workspace
   - Пользователь явно инициализирует и управляет workspace (создание, конфигурация, очистка)
   - Workspace содержит персональные агенты, конфигурации, состояние

2. **Агенты получают доступ только через tools**
   - Агент НЕ имеет прямого доступа к workspace объекту
   - Агент вызывает tools, которые:
     - Принимают контекст workspace как параметр
     - Выполняют операции в контексте этого workspace
     - Возвращают результаты агенту
   - Пример: `tool_get_agent_context()` → передается `workspace_id`, tool обращается к Qdrant, возвращает контекст

3. **Backend координирует доступ**
   - REST API endpoints получают `user_id` из JWT токена (user isolation middleware)
   - Backend поддерживает workspace для каждого пользователя
   - User Worker Space управляет жизненным циклом workspace
   - Tools запускаются в контексте пользовательского workspace

4. **Архитектурные границы доступа**
   - ✅ User → Client App → REST API ← Backend (User Worker Space)
   - ✅ Agent → Tool Call → (tool контекст из workspace) → Resource
   - ❌ Agent → прямой доступ к Qdrant, Redis, Database (только через tools)
   - ❌ Agent → инициализация workspace (только через User Worker Space backend)

### Изменения в спецификации

- Уточнение документации User Worker Space: явное разделение инициализации (backend) и использования (tools)
- Уточнение API контрактов: workspace context параметры в tool signatures
- Уточнение данных потока: где создается workspace, как передается между компонентами
- Документирование граничных условий: что происходит, если agent попытается обойти tools

---

## Capabilities

### Modified Capabilities

- **user-worker-space** (из implement-core-service)
  - **Clarification**: Явная документация того, что:
    - Workspace инициализируется backend'ом (User Worker Space component)
    - Агенты получают workspace context через tool parameters
    - Tools выполняют операции в контексте переданного workspace
    - Изоляция между пользователями обеспечивается на уровне backend (middleware + контекст в tools)

---

## Impact

### Влияние на документацию и спецификации

1. **Спецификация User Worker Space** (`openspec/changes/implement-core-service/specs/user-worker-space/spec.md`)
   - Добавление раздела "Workspace Access Architecture"
   - Диаграмма потока инициализации workspace
   - Документирование tool контекста и параметров
   - Примеры tool вызовов с workspace context

2. **API Документация** (`doc/rest-api.md`)
   - Уточнение, какие endpoints инициализируют/управляют workspace
   - Добавление информации о workspace context в tool parameters

3. **Архитектурные диаграммы**
   - Диаграмма взаимодействия Agent → Tool → Workspace Context
   - Диаграмма граничной безопасности между компонентами

### Влияние на понимание разработчиками

- ✅ Четкое разделение ответственности: User предоставляет, Backend управляет, Agents используют через tools
- ✅ Правильное понимание изоляции данных: изоляция на backend уровне, не на уровне agent
- ✅ Правильная реализация tools: всегда принимают workspace context как параметр
- ✅ Безопасность: агент не может обойти контроль доступа, т.к. tools обращаются к backend

### Затронутые компоненты

- **Документация**: User Worker Space spec, REST API docs, Architecture docs
- **User Worker Space компонента**: уточнение инициализации и lifecycle
- **Tool definitions**: все tools должны явно документировать workspace context параметры
- **Backend middleware**: подтверждение правильного взаимодействия с tools

### Риск минимален

Это уточнение архитектуры, а **не изменение функциональности**. Система уже работает согласно уточненной модели; это изменение только выводит неявные предположения в явную документацию.
