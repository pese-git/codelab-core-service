# Спецификация: Personal Orchestrator

## ADDED Requirements

### Requirement: Планирование графа задач из natural language
Orchestrator ДОЛЖЕН анализировать запрос пользователя и создавать граф задач для выполнения.

#### Scenario: Простой запрос с одной задачей
- **WHEN** пользователь отправляет запрос "Проверь код в auth.py"
- **THEN** orchestrator создает граф с одной задачей для агента "coder"

#### Scenario: Сложный запрос с несколькими задачами
- **WHEN** пользователь отправляет запрос "Найди информацию о FastAPI и создай REST API"
- **THEN** orchestrator создает граф с задачами: 1) researcher ищет информацию, 2) coder создает API

#### Scenario: Запрос с параллельными задачами
- **WHEN** пользователь отправляет запрос требующий независимых действий
- **THEN** orchestrator создает граф где независимые задачи могут выполняться параллельно

#### Scenario: Невозможность выполнения
- **WHEN** запрос не может быть выполнен доступными агентами
- **THEN** orchestrator возвращает ошибку с объяснением почему задача невыполнима

### Requirement: Анализ зависимостей между задачами
Orchestrator ДОЛЖЕН определять зависимости между задачами и строить корректный граф.

#### Scenario: Последовательные зависимости
- **WHEN** задача B требует результата задачи A
- **THEN** orchestrator создает зависимость A → B в графе

#### Scenario: Множественные зависимости
- **WHEN** задача C требует результатов задач A и B
- **THEN** orchestrator создает зависимости A → C и B → C

#### Scenario: Обнаружение циклических зависимостей
- **WHEN** граф содержит цикл (A → B → C → A)
- **THEN** orchestrator обнаруживает цикл и возвращает ошибку "Circular dependency detected"

#### Scenario: Независимые задачи
- **WHEN** задачи A и B не зависят друг от друга
- **THEN** orchestrator помечает их как параллельно выполняемые

### Requirement: Топологическая сортировка для параллельного выполнения
Orchestrator ДОЛЖЕН использовать топологическую сортировку для определения порядка выполнения.

#### Scenario: Определение уровней выполнения
- **WHEN** граф задач построен
- **THEN** orchestrator группирует задачи по уровням где задачи одного уровня могут выполняться параллельно

#### Scenario: Максимальный параллелизм
- **WHEN** граф содержит независимые задачи
- **THEN** orchestrator планирует их выполнение одновременно с учетом concurrency_limit (max 3 агента)

#### Scenario: Последовательное выполнение при зависимостях
- **WHEN** все задачи зависят друг от друга последовательно
- **THEN** orchestrator планирует их выполнение по одной

#### Scenario: Оптимизация порядка
- **WHEN** существует несколько валидных порядков выполнения
- **THEN** orchestrator выбирает порядок минимизирующий общее время выполнения

### Requirement: Оценка стоимости выполнения
Orchestrator ДОЛЖЕН оценивать стоимость выполнения плана в $ API calls.

#### Scenario: Оценка стоимости LLM вызовов
- **WHEN** план создан
- **THEN** orchestrator оценивает количество LLM API calls и их стоимость на основе моделей агентов

#### Scenario: Оценка стоимости embeddings
- **WHEN** план включает RAG поиск
- **THEN** orchestrator добавляет стоимость генерации embeddings к общей оценке

#### Scenario: Диапазон стоимости
- **WHEN** точная стоимость неизвестна
- **THEN** orchestrator предоставляет диапазон (min-max) стоимости

#### Scenario: Предупреждение о высокой стоимости
- **WHEN** оценочная стоимость превышает $1.00
- **THEN** orchestrator помечает план как "high_cost" и требует approval

### Requirement: Оценка времени выполнения
Orchestrator ДОЛЖЕН оценивать время выполнения плана.

#### Scenario: Оценка времени для простого плана
- **WHEN** план содержит одну задачу
- **THEN** orchestrator оценивает время как average_task_duration агента

#### Scenario: Оценка времени для последовательного плана
- **WHEN** план содержит последовательные задачи
- **THEN** orchestrator суммирует время выполнения всех задач

#### Scenario: Оценка времени для параллельного плана
- **WHEN** план содержит параллельные задачи
- **THEN** orchestrator оценивает время как максимум среди параллельных веток

#### Scenario: Диапазон времени
- **WHEN** время выполнения неопределенно
- **THEN** orchestrator предоставляет диапазон (min-max) в секундах

### Requirement: Интеграция с Approval Manager
Orchestrator ДОЛЖЕН интегрироваться с Approval Manager для получения подтверждения сложных планов.

#### Scenario: Автоматическое выполнение простого плана
- **WHEN** план содержит 1-2 задачи и стоимость < $0.10
- **THEN** orchestrator выполняет план без approval

#### Scenario: Запрос approval для сложного плана
- **WHEN** план содержит 3+ задачи или стоимость > $0.10
- **THEN** orchestrator отправляет план в Approval Manager и ждет подтверждения

#### Scenario: Выполнение после approval
- **WHEN** пользователь одобряет план
- **THEN** orchestrator начинает выполнение согласно графу задач

#### Scenario: Отмена при reject
- **WHEN** пользователь отклоняет план
- **THEN** orchestrator отменяет выполнение и возвращает сообщение об отмене

#### Scenario: Timeout approval
- **WHEN** пользователь не отвечает на approval request в течение 300 секунд
- **THEN** orchestrator автоматически отклоняет план

### Requirement: Выбор агентов для задач
Orchestrator ДОЛЖЕН выбирать подходящих агентов для каждой задачи на основе их capabilities.

#### Scenario: Выбор по типу задачи
- **WHEN** задача требует написания кода
- **THEN** orchestrator назначает задачу агенту с capability "coding"

#### Scenario: Выбор по доступности
- **WHEN** несколько агентов подходят для задачи
- **THEN** orchestrator выбирает агента со статусом "ready" и наименьшей загрузкой

#### Scenario: Отсутствие подходящего агента
- **WHEN** ни один агент не может выполнить задачу
- **THEN** orchestrator возвращает ошибку "No suitable agent available for task"

#### Scenario: Учет concurrency limit
- **WHEN** агент уже выполняет максимальное количество задач
- **THEN** orchestrator ставит новую задачу в очередь или выбирает другого агента

### Requirement: Мониторинг выполнения плана
Orchestrator ДОЛЖЕН отслеживать прогресс выполнения плана и отправлять обновления.

#### Scenario: Отправка SSE событий о прогрессе
- **WHEN** задача в плане начинается, выполняется или завершается
- **THEN** orchestrator отправляет SSE события: task_started, task_progress, task_completed

#### Scenario: Обработка успешного завершения задачи
- **WHEN** задача успешно завершена
- **THEN** orchestrator передает результат зависимым задачам и запускает их

#### Scenario: Обработка ошибки в задаче
- **WHEN** задача завершается с ошибкой
- **THEN** orchestrator останавливает зависимые задачи и помечает план как failed

#### Scenario: Частичный успех
- **WHEN** некоторые задачи успешны, но одна failed
- **THEN** orchestrator завершает успешные задачи и возвращает partial_success с деталями

### Requirement: Кеширование планов
Orchestrator ДОЛЖЕН кешировать похожие планы для ускорения планирования.

#### Scenario: Сохранение плана в cache
- **WHEN** план успешно создан и выполнен
- **THEN** orchestrator сохраняет план в Redis с ключом на основе hash запроса

#### Scenario: Использование закешированного плана
- **WHEN** пользователь отправляет похожий запрос
- **THEN** orchestrator находит план в cache и использует его вместо создания нового

#### Scenario: Инвалидация cache
- **WHEN** конфигурация агентов изменяется
- **THEN** orchestrator инвалидирует все планы в cache связанные с этими агентами

#### Scenario: TTL cache
- **WHEN** план сохраняется в cache
- **THEN** TTL устанавливается на 24 часа

### Requirement: Производительность планирования
Orchestrator ДОЛЖЕН создавать планы с минимальной задержкой.

#### Scenario: Планирование простых запросов
- **WHEN** запрос требует 1-2 задачи
- **THEN** планирование завершается менее чем за 2 секунды

#### Scenario: Планирование сложных запросов
- **WHEN** запрос требует 3+ задачи с зависимостями
- **THEN** планирование завершается менее чем за 5 секунд

#### Scenario: Timeout планирования
- **WHEN** планирование занимает более 5 секунд
- **THEN** orchestrator возвращает fallback план с последовательным выполнением
