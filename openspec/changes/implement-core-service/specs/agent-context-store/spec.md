# Спецификация: Agent Context Store

## ADDED Requirements

### Requirement: Инициализация Qdrant collection для агента
Система ДОЛЖНА создавать отдельную Qdrant collection для каждого агента при его создании.

#### Scenario: Создание collection при создании агента
- **WHEN** новый агент создается
- **THEN** система создает Qdrant collection с именем "user{user_id}_{agent_name}_context" и vector size 1536 (OpenAI embeddings)

#### Scenario: Проверка существования collection
- **WHEN** система инициализирует агента
- **THEN** система проверяет существование Qdrant collection и создает её если отсутствует

#### Scenario: Конфигурация collection
- **WHEN** collection создается
- **THEN** система настраивает индексы для полей: task_id, timestamp, success, interaction_type

#### Scenario: Изоляция collections
- **WHEN** создается collection для агента User123
- **THEN** collection полностью изолирована от collections других пользователей

### Requirement: Сохранение взаимодействий агента
Система ДОЛЖНА сохранять все взаимодействия агента с embeddings в Qdrant.

#### Scenario: Сохранение успешного взаимодействия
- **WHEN** агент успешно выполняет задачу
- **THEN** система сохраняет в Qdrant: текст взаимодействия, embedding, metadata (task_id, timestamp, success=true, type)

#### Scenario: Сохранение неудачного взаимодействия
- **WHEN** агент не может выполнить задачу
- **THEN** система сохраняет взаимодействие с success=false и error_details в metadata

#### Scenario: Типы взаимодействий
- **WHEN** система сохраняет взаимодействие
- **THEN** тип взаимодействия указывается в metadata: "task_execution", "tool_call", "user_message", "agent_response"

#### Scenario: Генерация embeddings
- **WHEN** взаимодействие сохраняется
- **THEN** система генерирует embedding используя OpenAI text-embedding-3-small модель

### Requirement: RAG поиск в контексте агента
Система ДОЛЖНА предоставлять API для семантического поиска в контексте агента.

#### Scenario: Hybrid search
- **WHEN** агент запрашивает релевантный контекст для задачи
- **THEN** система выполняет hybrid search (vector similarity + metadata filtering) и возвращает top-k результатов

#### Scenario: Фильтрация по типу взаимодействия
- **WHEN** поиск выполняется с фильтром по interaction_type
- **THEN** система возвращает только взаимодействия указанного типа

#### Scenario: Фильтрация по успешности
- **WHEN** поиск выполняется с фильтром success=true
- **THEN** система возвращает только успешные взаимодействия

#### Scenario: Временная фильтрация
- **WHEN** поиск выполняется с временным диапазоном
- **THEN** система возвращает только взаимодействия в указанном периоде

#### Scenario: Производительность поиска
- **WHEN** система выполняет RAG поиск
- **THEN** поиск завершается менее чем за 50ms (P95)

### Requirement: Управление памятью агента
Система ДОЛЖНА предоставлять операции для управления памятью агента.

#### Scenario: Очистка всей памяти
- **WHEN** пользователь вызывает clear operation для агента
- **THEN** система удаляет все vectors из Qdrant collection агента

#### Scenario: Pruning старых записей
- **WHEN** пользователь вызывает prune operation с параметром days=30
- **THEN** система удаляет все vectors старше 30 дней из collection агента

#### Scenario: Pruning по размеру
- **WHEN** collection агента превышает max_vectors лимит
- **THEN** система автоматически удаляет самые старые vectors до достижения лимита

#### Scenario: Selective pruning
- **WHEN** пользователь вызывает prune с фильтром (например, success=false)
- **THEN** система удаляет только vectors соответствующие фильтру

### Requirement: Экспорт контекста агента
Система ДОЛЖНА позволять экспортировать контекст агента для анализа или backup.

#### Scenario: Экспорт в JSON
- **WHEN** пользователь запрашивает экспорт контекста агента
- **THEN** система возвращает JSON файл со всеми взаимодействиями и metadata (без embeddings)

#### Scenario: Экспорт с embeddings
- **WHEN** пользователь запрашивает полный экспорт с параметром include_embeddings=true
- **THEN** система возвращает JSON файл включая embeddings vectors

#### Scenario: Фильтрованный экспорт
- **WHEN** пользователь экспортирует с фильтрами (date range, type)
- **THEN** система экспортирует только взаимодействия соответствующие фильтрам

#### Scenario: Формат экспорта
- **WHEN** экспорт выполняется
- **THEN** файл содержит поля: agent_id, export_date, total_interactions, interactions[]

### Requirement: Статистика контекста
Система ДОЛЖНА предоставлять статистику по контексту агента.

#### Scenario: Общая статистика
- **WHEN** пользователь запрашивает статистику агента
- **THEN** система возвращает: total_vectors, collection_size_mb, oldest_interaction, newest_interaction

#### Scenario: Статистика по типам
- **WHEN** пользователь запрашивает детальную статистику
- **THEN** система возвращает breakdown по interaction_type с количеством для каждого типа

#### Scenario: Статистика успешности
- **WHEN** статистика запрашивается
- **THEN** система возвращает success_rate (процент успешных взаимодействий)

#### Scenario: Временная статистика
- **WHEN** пользователь запрашивает статистику за период
- **THEN** система возвращает агрегированные данные по дням/неделям

### Requirement: Автоматическое управление размером
Система ДОЛЖНА автоматически управлять размером Qdrant collections для предотвращения переполнения.

#### Scenario: Мониторинг размера collection
- **WHEN** система периодически проверяет размер collections
- **THEN** проверка выполняется каждые 24 часа для всех активных агентов

#### Scenario: Предупреждение о приближении к лимиту
- **WHEN** collection агента достигает 80% от max_vectors лимита
- **THEN** система отправляет предупреждение пользователю через SSE

#### Scenario: Автоматический pruning при лимите
- **WHEN** collection достигает 100% лимита
- **THEN** система автоматически удаляет 20% самых старых vectors

#### Scenario: Конфигурируемые лимиты
- **WHEN** пользователь создает агента
- **THEN** можно указать max_vectors лимит (по умолчанию 1M vectors)

### Requirement: Изоляция контекста
Система ДОЛЖНА обеспечивать полную изоляцию контекста между агентами и пользователями.

#### Scenario: Изоляция между агентами одного пользователя
- **WHEN** User123 имеет агентов "coder" и "researcher"
- **THEN** контекст "coder" полностью изолирован от контекста "researcher"

#### Scenario: Изоляция между пользователями
- **WHEN** User123 и User456 имеют агентов с одинаковым именем
- **THEN** их контексты полностью изолированы в разных Qdrant collections

#### Scenario: Предотвращение cross-agent доступа
- **WHEN** агент запрашивает контекст
- **THEN** система возвращает только vectors из collection этого агента
