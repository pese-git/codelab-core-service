# Design: Уточнение механизма доступа к workspace

## Context

При реализации изменения `implement-core-service` возникла необходимость в явном уточнении архитектуры доступа к workspace. Текущая документация содержит неявные предположения о том, как агенты получают доступ к рабочему пространству пользователя, что может привести к неправильной реализации и нарушению изоляции данных.

**Текущее состояние:**
- Спецификация User Worker Space описывает функциональность, но не детализирует архитектурный поток доступа
- Отсутствует явная документация о том, что workspace предоставляется пользователем через client приложение
- Не зафиксировано, что агенты получают доступ к workspace исключительно через tools, а не напрямую
- Нет четкого разделения ответственности между компонентами системы

**Ограничения:**
- Изменение должно быть чисто документационным - не меняет существующую функциональность
- Должно сохранить совместимость с текущей архитектурой
- Не должно требовать изменений в коде (только уточнение документации)

**Заинтересованные стороны:**
- Разработчики backend (понимание архитектуры изоляции)
- Разработчики client приложений (понимание инициализации workspace)
- Разработчики агентов (понимание механизма доступа через tools)
- Архитекторы системы (валидация безопасности и изоляции)

## Goals / Non-Goals

**Goals:**
- Явно документировать, что workspace предоставляется конечным пользователем через client приложение
- Зафиксировать, что агенты получают доступ к workspace только через tools с передачей контекста
- Описать архитектурный поток: User → Client → Backend → Tools → Resources
- Определить границы ответственности каждого компонента в управлении workspace
- Добавить диаграммы и примеры для наглядности архитектурного потока
- Документировать граничные условия безопасности (что агент НЕ может делать)

**Non-Goals:**
- Изменение существующей функциональности или кода
- Реализация новых API endpoints или компонентов
- Изменение механизма аутентификации или авторизации
- Добавление новых инструментов или capabilities для агентов
- Изменение структуры базы данных или схемы Qdrant collections

## Decisions

### Decision 1: ✅ Workspace как user-provided ресурс (инициализируется пользователем)

**ФИКСИРОВАННОЕ РЕШЕНИЕ:**
Workspace инициализируется и управляется пользователем через client приложение, а не является системным ресурсом, инициализируемым сервером.

**Обоснование:**
- Соответствует принципу user ownership - пользователь владеет своими данными и workspace
- Упрощает понимание lifecycle: создание, конфигурация, очистка контролируются пользователем
- Четко разделяет ответственность: client управляет UI/UX workspace, backend обеспечивает backend logic
- Исключает неявное предположение о системной инициализации workspace

**Архитектурный контракт:**
```
User (Client App) инициализирует workspace
         ↓
Backend (User Worker Space) получает инициализацию через REST API
         ↓
Backend управляет жизненным циклом: создание ресурсов, кэш, Qdrant collections
         ↓
Backend предоставляет workspace context для tools
```

**Альтернативы (отклонены):**
- *Системная инициализация workspace*: backend автоматически создает workspace при первом запросе
  - ❌ Снижает контроль пользователя, усложняет кастомизацию workspace
- *Гибридный подход*: часть workspace управляется системой, часть пользователем
  - ❌ Создает путаницу в ответственности, усложняет документацию

### Decision 2: ✅ Агенты получают доступ ТОЛЬКО через tools с workspace context

**ФИКСИРОВАННОЕ РЕШЕНИЕ:**
Агенты НЕ имеют прямого доступа к workspace объекту. Весь доступ к ресурсам (Qdrant, Redis, Database) осуществляется исключительно через tools, которые получают workspace context как параметр.

**Обоснование:**
- **Безопасность**: Агент не может обойти контроль доступа или получить доступ к данным других пользователей
- **Аудит**: Все операции с workspace проходят через tools, которые можно логировать
- **Гибкость**: Tools могут применять дополнительные проверки безопасности перед доступом
- **Least Privilege**: Агент получает только те данные, которые явно запросил через tool

**Архитектурный контракт:**
```
Agent.execute_tool(tool_name, params)
         ↓
ToolExecutor.execute(tool_name, workspace_id, params)
         ↓
Tool.execute(workspace_context={user_id, workspace_id, project_id}, params)
         ↓
Tool обращается к resource (Qdrant/Redis/DB) с контекстом
         ↓
Возврат результата агенту

❌ Agent.workspace (прямой доступ) - ЗАПРЕЩЕНО
❌ Agent.qdrant_client (прямой доступ) - ЗАПРЕЩЕНО
❌ Agent.redis_client (прямой доступ) - ЗАПРЕЩЕНО
```

**Альтернативы (отклонены):**
- *Прямой доступ агентов к workspace*: агент получает workspace объект и работает напрямую
  - ❌ Нарушает изоляцию между пользователями
- *Смешанный доступ*: некоторые операции через tools, некоторые напрямую
  - ❌ Создает inconsistency и уязвимости в безопасности

### Decision 3: ✅ Backend координирует lifecycle через User Worker Space компоненту

**ФИКСИРОВАННОЕ РЕШЕНИЕ:**
User Worker Space компонента backend централизованно отвечает за инициализацию, управление и graceful cleanup workspace на стороне сервера.

**Обоснование:**
- **Централизация**: Вся backend логика workspace в одном компоненте, упрощает поддержку
- **Изоляция**: User Worker Space использует user_id из JWT для проверки доступа
- **Управление ресурсами**: Backend контролирует agent_cache, Qdrant collections, Redis keys, database connections
- **Graceful cleanup**: Backend может корректно завершить задачи и освободить ресурсы при logout

**Архитектурный контракт:**
```
User Worker Space отвечает за:
✅ Инициализацию workspace при first request
✅ Управление agent_cache (создание, кэширование, удаление агентов)
✅ Управление Qdrant collections (создание, индексирование, удаление)
✅ Управление Redis ключами (очереди, кэши, состояния)
✅ User isolation validation (проверка user_id для всех операций)
✅ Graceful cleanup при logout или timeout
```

**Альтернативы (отклонены):**
- *Распределенное управление*: каждый компонент управляет своей частью
  - ❌ Усложняет координацию, риск утечки ресурсов при cleanup
- *Client-side управление lifecycle*: client приложение управляет всем
  - ❌ Client не имеет доступа к backend ресурсам (Qdrant, Redis, Database)

### Decision 4: ✅ Обновление существующей спецификации User Worker Space

**ФИКСИРОВАННОЕ РЕШЕНИЕ:**
Добавить новый раздел "Workspace Access Architecture" в существующую спецификацию User Worker Space вместо создания отдельного документа.

**Обоснование:**
- **Консолидация**: Вся информация о User Worker Space в одном месте
- **Контекст**: Разработчики видят архитектуру доступа рядом с requirements
- **Избежание дублирования**: Не нужно повторять базовую информацию о User Worker Space
- **Связность**: Легче поддерживать в актуальном состоянии

**Структура обновления:**
```
openspec/specs/user-worker-space/spec.md
├── Existing sections (Responsibilities, API, etc.)
├── NEW: Workspace Access Architecture
│   ├── Overview diagram
│   ├── User initialization flow
│   ├── Tool access pattern with workspace context
│   ├── Agent isolation guarantees
│   └── Security boundaries
└── Examples with workspace context
```

**Альтернативы (отклонены):**
- *Отдельный архитектурный документ*: создать `workspace-access-architecture.md`
  - ❌ Фрагментирует документацию, требует cross-references
- *Обновление общей архитектурной документации*: добавить в `doc/architecture.md`
  - ❌ Слишком общий уровень, теряется связь с User Worker Space спецификацией

## Risks / Trade-offs

### Risk 1: Документация может устареть при изменении реализации
**Митигация:** 
- Включить проверку документации в процесс code review
- Добавить ссылки на документацию в комментариях к коду User Worker Space
- Периодический аудит соответствия документации и реализации

### Risk 2: Разработчики могут не прочитать уточненную документацию
**Митигация:**
- Добавить диаграммы и визуальные примеры для быстрого понимания
- Включить ключевые моменты в onboarding документацию для новых разработчиков
- Создать checklist для code review с проверкой соответствия архитектуре доступа

### Risk 3: Уточнение может выявить несоответствия в текущей реализации
**Митигация:**
- Провести аудит текущей реализации User Worker Space на соответствие уточненной архитектуре
- Если найдены несоответствия, создать отдельные issues для их исправления
- Документировать временные отклонения с планом их устранения

### Trade-off 1: Детализация vs. Читаемость
**Решение:** Использовать многоуровневую структуру документации:
- Краткий overview с диаграммой для быстрого понимания
- Детальные секции для каждого аспекта (инициализация, tool access, lifecycle)
- Примеры кода для конкретных use cases

### Trade-off 2: Документация vs. Код как источник истины
**Решение:** Документация описывает архитектурные принципы и контракты, код реализует детали. При конфликте - код имеет приоритет, но требует обновления документации.

## Migration Plan

Это документационное изменение, не требующее миграции кода или данных.

**Шаги развертывания:**
1. Создать delta spec с уточнениями для User Worker Space
2. Review delta spec с командой разработки
3. Merge delta spec в main спецификацию User Worker Space
4. Обновить связанную документацию (REST API docs, если требуется)
5. Анонсировать изменения команде через changelog или team meeting

**Rollback стратегия:**
- Документационные изменения можно откатить через git revert
- Нет влияния на работающую систему, rollback не требует downtime

**Валидация:**
- Code review существующей реализации User Worker Space на соответствие уточненной архитектуре
- Проверка, что все tools корректно принимают workspace context параметры
- Валидация, что middleware корректно изолирует workspace между пользователями

## Open Questions

### Q1: Нужно ли добавлять примеры tool signatures с workspace context?
**Статус:** Требует обсуждения с командой разработки агентов

**Варианты:**
- Добавить примеры в спецификацию User Worker Space
- Создать отдельный документ с примерами tool definitions
- Добавить примеры в документацию каждого конкретного tool

**Рекомендация:** Добавить 2-3 примера в спецификацию User Worker Space для иллюстрации паттерна, детальные примеры оставить в документации конкретных tools.

### Q2: Требуется ли обновление REST API документации?
**Статус:** Зависит от того, насколько явно API endpoints документируют workspace context

**Действие:** Проверить `doc/rest-api.md` и определить, нужны ли уточнения о том, какие endpoints инициализируют/управляют workspace.

### Q3: Нужна ли диаграмма sequence для потока workspace access?
**Статус:** Желательно для наглядности

**Рекомендация:** Добавить mermaid sequence diagram в спецификацию, показывающую поток: User → Client → REST API → User Worker Space → Tool → Resource (Qdrant/Redis/DB).
