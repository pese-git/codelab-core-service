# Спецификация: Personal Agents Management

## ADDED Requirements

### Requirement: Создание персонального агента
Система ДОЛЖНА позволять пользователям создавать персональных агентов с уникальной конфигурацией.

#### Scenario: Успешное создание агента
- **WHEN** пользователь отправляет POST запрос с валидной конфигурацией агента (name, system_prompt, model, tools)
- **THEN** система создает агента с ID формата "user{id}_{name}_{version}" и возвращает 201 Created

#### Scenario: Дублирование имени агента
- **WHEN** пользователь пытается создать агента с именем уже существующего агента
- **THEN** система возвращает 409 Conflict с сообщением "Agent with this name already exists"

#### Scenario: Невалидная конфигурация
- **WHEN** пользователь отправляет конфигурацию с отсутствующими обязательными полями
- **THEN** система возвращает 422 Unprocessable Entity с деталями валидационных ошибок

#### Scenario: Инициализация Qdrant collection
- **WHEN** агент успешно создан
- **THEN** система автоматически создает Qdrant collection с именем "user{id}_{name}_context"

### Requirement: Получение списка агентов
Система ДОЛЖНА предоставлять список всех агентов пользователя с их статусами.

#### Scenario: Получение списка агентов
- **WHEN** пользователь отправляет GET запрос к `/my/agents/`
- **THEN** система возвращает список всех агентов пользователя с полями: id, name, status, created_at, config

#### Scenario: Фильтрация по статусу
- **WHEN** пользователь запрашивает агентов с query параметром `?status=ready`
- **THEN** система возвращает только агентов со статусом "ready"

#### Scenario: Пустой список агентов
- **WHEN** у пользователя нет созданных агентов
- **THEN** система возвращает пустой массив с HTTP 200 OK

#### Scenario: Изоляция агентов
- **WHEN** User123 запрашивает список агентов
- **THEN** система возвращает только агентов User123, агенты других пользователей недоступны

### Requirement: Получение конфигурации агента
Система ДОЛЖНА предоставлять детальную конфигурацию конкретного агента.

#### Scenario: Успешное получение агента
- **WHEN** пользователь отправляет GET запрос к `/my/agents/{agent_id}`
- **THEN** система возвращает полную конфигурацию агента включая system_prompt, model, tools, concurrency_limit

#### Scenario: Агент не найден
- **WHEN** пользователь запрашивает несуществующего агента
- **THEN** система возвращает 404 Not Found с сообщением "Agent not found"

#### Scenario: Доступ к чужому агенту
- **WHEN** User123 пытается получить агента принадлежащего User456
- **THEN** система возвращает 404 Not Found (не раскрывая существование агента)

### Requirement: Обновление конфигурации агента
Система ДОЛЖНА позволять обновлять конфигурацию существующих агентов.

#### Scenario: Успешное обновление
- **WHEN** пользователь отправляет PUT запрос с обновленной конфигурацией
- **THEN** система обновляет агента, инвалидирует cache и возвращает 200 OK с обновленными данными

#### Scenario: Частичное обновление
- **WHEN** пользователь отправляет PATCH запрос с частичной конфигурацией
- **THEN** система обновляет только указанные поля, остальные остаются без изменений

#### Scenario: Обновление во время выполнения задачи
- **WHEN** агент обновляется пока выполняет задачу
- **THEN** система применяет изменения после завершения текущей задачи

#### Scenario: Невалидное обновление
- **WHEN** пользователь отправляет невалидные данные для обновления
- **THEN** система возвращает 422 Unprocessable Entity без изменения агента

### Requirement: Удаление агента
Система ДОЛЖНА позволять удалять агентов с полной очисткой ресурсов.

#### Scenario: Успешное удаление
- **WHEN** пользователь отправляет DELETE запрос к `/my/agents/{agent_id}`
- **THEN** система удаляет агента, его Qdrant collection, очищает cache и возвращает 204 No Content

#### Scenario: Удаление активного агента
- **WHEN** пользователь удаляет агента выполняющего задачи
- **THEN** система останавливает все задачи агента, затем удаляет его

#### Scenario: Удаление несуществующего агента
- **WHEN** пользователь пытается удалить несуществующего агента
- **THEN** система возвращает 404 Not Found

#### Scenario: Каскадное удаление данных
- **WHEN** агент удаляется
- **THEN** система удаляет все связанные данные: tasks, messages, Qdrant vectors, cache entries

### Requirement: Отслеживание статуса агента
Система ДОЛЖНА отслеживать и обновлять статус каждого агента в реальном времени.

#### Scenario: Статус ready
- **WHEN** агент создан и готов к выполнению задач
- **THEN** система устанавливает статус "ready"

#### Scenario: Статус busy
- **WHEN** агент выполняет задачу
- **THEN** система устанавливает статус "busy" и отправляет SSE событие agent_status_changed

#### Scenario: Статус error
- **WHEN** агент сталкивается с критической ошибкой
- **THEN** система устанавливает статус "error" с деталями ошибки и отправляет SSE событие

#### Scenario: Автоматическое восстановление
- **WHEN** агент в статусе "error" и прошло 60 секунд
- **THEN** система пытается автоматически восстановить агента в статус "ready"

### Requirement: Health checks агентов
Система ДОЛЖНА выполнять периодические health checks для всех агентов.

#### Scenario: Успешный health check
- **WHEN** система выполняет health check агента
- **THEN** агент отвечает в течение 5 секунд и health check считается успешным

#### Scenario: Неудачный health check
- **WHEN** агент не отвечает на health check в течение 5 секунд
- **THEN** система помечает агента как unhealthy и отправляет алерт

#### Scenario: Периодичность health checks
- **WHEN** агент активен
- **THEN** система выполняет health check каждые 60 секунд

### Requirement: Метрики агентов
Система ДОЛЖНА собирать и предоставлять метрики для каждого агента.

#### Scenario: Метрики выполнения
- **WHEN** пользователь запрашивает метрики агента
- **THEN** система возвращает: total_tasks, successful_tasks, failed_tasks, average_duration, last_active_at

#### Scenario: Метрики использования ресурсов
- **WHEN** агент выполняет задачи
- **THEN** система отслеживает: API calls count, tokens used, cost estimation

#### Scenario: История метрик
- **WHEN** пользователь запрашивает историю метрик за период
- **THEN** система возвращает агрегированные метрики по дням/часам
