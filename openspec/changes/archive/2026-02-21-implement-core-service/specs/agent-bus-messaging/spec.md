# Спецификация: Agent Bus Messaging

## ADDED Requirements

### Requirement: Регистрация агентов в Bus
Agent Bus ДОЛЖЕН позволять регистрировать агентов с их параметрами concurrency.

#### Scenario: Успешная регистрация агента
- **WHEN** агент регистрируется в Bus с agent_id и max_concurrency=3
- **THEN** Bus создает asyncio.Queue для агента с maxsize=100 и запускает worker task

#### Scenario: Повторная регистрация агента
- **WHEN** агент с существующим agent_id регистрируется повторно
- **THEN** Bus возвращает ошибку "Agent already registered"

#### Scenario: Регистрация с невалидным concurrency
- **WHEN** агент регистрируется с max_concurrency < 1 или > 10
- **THEN** Bus возвращает ошибку "Invalid concurrency limit"

#### Scenario: Автоматический запуск worker
- **WHEN** агент успешно зарегистрирован
- **THEN** Bus автоматически запускает worker task для обработки очереди агента

### Requirement: Дерегистрация агентов
Agent Bus ДОЛЖЕН позволять корректно дерегистрировать агентов с очисткой ресурсов.

#### Scenario: Успешная дерегистрация
- **WHEN** агент дерегистрируется из Bus
- **THEN** Bus останавливает worker task, очищает очередь и удаляет агента из реестра

#### Scenario: Дерегистрация с активными задачами
- **WHEN** агент дерегистрируется пока выполняет задачи
- **THEN** Bus ждет завершения текущих задач (до 30 сек), затем force stop

#### Scenario: Дерегистрация несуществующего агента
- **WHEN** попытка дерегистрировать незарегистрированного агента
- **THEN** Bus возвращает ошибку "Agent not registered"

#### Scenario: Graceful shutdown
- **WHEN** дерегистрация выполняется с параметром graceful=true
- **THEN** Bus ждет завершения всех задач в очереди перед остановкой

### Requirement: Управление очередью задач
Agent Bus ДОЛЖЕН управлять очередью задач для каждого агента.

#### Scenario: Добавление задачи в очередь
- **WHEN** задача отправляется агенту через Bus
- **THEN** Bus добавляет задачу в asyncio.Queue агента

#### Scenario: Переполнение очереди
- **WHEN** очередь агента заполнена (100 задач) и приходит новая задача
- **THEN** Bus возвращает ошибку "Agent queue is full" с HTTP 503

#### Scenario: Приоритизация задач
- **WHEN** задача отправляется с параметром priority=high
- **THEN** Bus добавляет задачу в начало очереди

#### Scenario: Отмена задачи в очереди
- **WHEN** пользователь отменяет задачу находящуюся в очереди
- **THEN** Bus удаляет задачу из очереди и отправляет SSE событие task_cancelled

### Requirement: Параллельное выполнение задач
Agent Bus ДОЛЖЕН контролировать параллельное выполнение задач согласно concurrency_limit.

#### Scenario: Выполнение в пределах лимита
- **WHEN** агент с max_concurrency=3 имеет 2 активные задачи
- **THEN** Bus немедленно запускает третью задачу из очереди

#### Scenario: Ожидание при достижении лимита
- **WHEN** агент выполняет максимальное количество задач (3)
- **THEN** Bus ждет завершения одной из задач перед запуском следующей

#### Scenario: Динамическое изменение concurrency
- **WHEN** concurrency_limit агента изменяется во время работы
- **THEN** Bus применяет новый лимит к новым задачам без прерывания текущих

#### Scenario: Мониторинг активных задач
- **WHEN** Bus выполняет задачи
- **THEN** Bus отслеживает количество активных задач для каждого агента

### Requirement: Координация при оркестрации
Agent Bus ДОЛЖЕН координировать выполнение задач при автоматическом планировании.

#### Scenario: Последовательное выполнение зависимых задач
- **WHEN** orchestrator отправляет граф с зависимостями A → B
- **THEN** Bus запускает задачу B только после успешного завершения A

#### Scenario: Параллельное выполнение независимых задач
- **WHEN** orchestrator отправляет независимые задачи A и B
- **THEN** Bus запускает обе задачи параллельно (если позволяет concurrency)

#### Scenario: Передача результатов между задачами
- **WHEN** задача A завершается с результатом
- **THEN** Bus передает результат задаче B если B зависит от A

#### Scenario: Остановка зависимых задач при ошибке
- **WHEN** задача A завершается с ошибкой
- **THEN** Bus отменяет все зависимые задачи (B, C) и помечает их как cancelled

### Requirement: Обработка ошибок выполнения
Agent Bus ДОЛЖЕН корректно обрабатывать ошибки при выполнении задач.

#### Scenario: Retry при временной ошибке
- **WHEN** задача завершается с временной ошибкой (timeout, rate limit)
- **THEN** Bus повторяет задачу до 3 раз с exponential backoff

#### Scenario: Permanent failure
- **WHEN** задача завершается с критической ошибкой или исчерпаны retry
- **THEN** Bus помечает задачу как failed и отправляет SSE событие task_failed

#### Scenario: Agent crash recovery
- **WHEN** worker task агента падает
- **THEN** Bus автоматически перезапускает worker и восстанавливает обработку очереди

#### Scenario: Логирование ошибок
- **WHEN** происходит ошибка в Bus
- **THEN** Bus логирует ошибку с полным контекстом (agent_id, task_id, error_details)

### Requirement: Статус задач
Agent Bus ДОЛЖЕН отслеживать и обновлять статус каждой задачи.

#### Scenario: Статус queued
- **WHEN** задача добавлена в очередь
- **THEN** Bus устанавливает статус "queued" и отправляет SSE событие

#### Scenario: Статус running
- **WHEN** задача начинает выполняться
- **THEN** Bus устанавливает статус "running" и отправляет SSE событие task_started

#### Scenario: Статус completed
- **WHEN** задача успешно завершается
- **THEN** Bus устанавливает статус "completed" с результатом и отправляет SSE событие task_completed

#### Scenario: Статус failed
- **WHEN** задача завершается с ошибкой
- **THEN** Bus устанавливает статус "failed" с error_details и отправляет SSE событие

### Requirement: Метрики и мониторинг
Agent Bus ДОЛЖЕН предоставлять метрики для мониторинга производительности.

#### Scenario: Метрики очередей
- **WHEN** система запрашивает метрики Bus
- **THEN** Bus возвращает для каждого агента: queue_size, active_tasks, completed_tasks, failed_tasks

#### Scenario: Метрики производительности
- **WHEN** задачи выполняются
- **THEN** Bus отслеживает: average_task_duration, p95_duration, throughput (tasks/sec)

#### Scenario: Алерты при проблемах
- **WHEN** очередь агента заполнена на 80%
- **THEN** Bus отправляет алерт "Agent queue near capacity"

#### Scenario: Health check
- **WHEN** система проверяет здоровье Bus
- **THEN** Bus возвращает статус всех worker tasks и очередей

### Requirement: Backpressure handling
Agent Bus ДОЛЖЕН корректно обрабатывать backpressure при перегрузке.

#### Scenario: Отклонение новых задач при перегрузке
- **WHEN** все агенты перегружены (очереди заполнены)
- **THEN** Bus возвращает 503 Service Unavailable с retry-after header

#### Scenario: Throttling входящих задач
- **WHEN** система обнаруживает перегрузку
- **THEN** Bus применяет rate limiting на новые задачи

#### Scenario: Приоритизация критичных задач
- **WHEN** система перегружена
- **THEN** Bus обрабатывает задачи с priority=high в первую очередь

#### Scenario: Graceful degradation
- **WHEN** Bus не может обработать задачу в разумное время
- **THEN** Bus возвращает ошибку с рекомендацией повторить позже
